<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S PROCUREMENT</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/purchase-order.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #F4F5F7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1F3866;
            --sidebar-active-text: #ffffff; --content-bg: #F8F9FE; --card-bg: #ffffff;
            --text-dark: #32325D; --text-muted: #8898AA; --border-color: #E9ECEF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        #login-container a { color: var(--info-color); }
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; color: rgba(255,255,255,0.7); background: transparent; border: none; padding: 5px; }
        .wrapper { display: flex; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transition: all 0.3s ease-in-out; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
        .main-content { width: 100%; padding: 30px; margin-left: 260px; transition: margin-left 0.3s ease-in-out; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://laserpowerinfra.com/frontassets/img/slider/Banner_v04_HD_L.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-tasks text-info"></i> DEB'S PROCUREMENT</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <button type="button" class="toggle-password" id="togglePassword" aria-label="Toggle password visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>

    <div id="app-container" class="wrapper hidden">
        </div>

    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Create Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="register-form">
                        <div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="User">User</option><option value="Vendor">Vendor</option></select></div>
                        <div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div>
                        <div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div>
                        <div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div>
                        <div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div>
                        <div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div>
                        <div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div>
                        <button type="submit" class="btn btn-success w-100 fw-bold">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"></div>
    <div class="modal fade" id="addUserModal" tabindex="-1"></div>
    <div class="modal fade" id="reopenBiddingModal" tabindex="-1"></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"></div>
    <div class="modal fade" id="advancedBulkAwardModal" tabindex="-1"></div>
    <div class="modal fade" id="forcePasswordResetModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"></div>
    <div class="modal fade" id="assignVendorsModal" tabindex="-1"></div>
    <div class="modal fade" id="bulkBidErrorModal" tabindex="-1"></div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        // =========================================================
        // ================ CONFIG & STATE =========================
        // =========================================================
        const API_BASE_URL = '/api';
        let loginWrapper, appContainer, mainView, headerTitle;
        let registerModal, adminActionModal, editUserModal, bulkUploadModal, advancedBulkAwardModal, reopenBiddingModal, bulkBidErrorModal;
        let addUserModal, forcePasswordResetModal, assignVendorsModal;
        
        // =========================================================
        // ================ CORE APP LOGIC =========================
        // =========================================================
        $(document).ready(() => {
            // --- Initialize variables ---
            loginWrapper = $('#login-wrapper'); 
            appContainer = $('#app-container'); 
            mainView = $('#main-view'); 
            headerTitle = $('#header-title');
            
            // --- CRITICAL FIX: Initialize all modals correctly ---
            try { 
                registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
                adminActionModal = new bootstrap.Modal(document.getElementById('adminActionModal'));
                editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
                // Add all other modals here using the same pattern
            } catch (e) { 
                console.error("Error initializing Bootstrap modals. Make sure all modal HTML elements exist.", e); 
            }
            
            // --- Check for existing session ---
            const user = sessionStorage.getItem('loggedInUser');
            if (user && sessionStorage.getItem('authToken')) { 
                setupUIForRole(JSON.parse(user)); 
            } else { 
                loginWrapper.removeClass('hidden'); 
                appContainer.addClass('hidden'); 
            }
            
            // --- Attach Event Listeners ---
            $('#login-form').on('submit', handleLogin);
            $('#register-form').on('submit', handleRegistration);
            $('#reg-role').on('change', handleRoleChange);
            
            // --- EYE BUTTON FIX ---
            $('#togglePassword').on('click', function() { 
                const passwordInput = $('#password'); 
                const type = passwordInput.attr('type') === 'password' ? 'text' : 'password'; 
                passwordInput.attr('type', type); 
                $(this).find('i').toggleClass('fa-eye-slash fa-eye'); 
            });
        });

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
            showLoader();
            try {
                const headers = {};
                const token = sessionStorage.getItem('authToken');
                if (token) headers['Authorization'] = `Bearer ${token}`;
                if (!isFormData) headers['Content-Type'] = 'application/json';
                
                const options = { method, headers };
                if (body) options.body = isFormData ? body : JSON.stringify(body);
                
                const finalUrl = API_BASE_URL + endpoint;
                const response = await fetch(finalUrl, options);
                
                let result;
                try {
                    result = await response.json();
                } catch (e) {
                    throw new Error("Invalid response from server.");
                }

                if (!response.ok) {
                    // --- AUTO-REFRESH FIX ---
                    // Only triggers logout/reload for session errors (401) on authenticated pages, NOT for login failures.
                    if (response.status === 401 && !endpoint.includes('/login')) {
                        showToast('Session expired. Please log in again.', 'error');
                        setTimeout(handleLogout, 2000); // Give user time to see toast
                    }
                    const error = new Error(result.message || `Server error: ${response.status}`);
                    throw error;
                }
                return result;
            } catch (error) {
                console.error(`API Call Failed for endpoint: ${endpoint}`, error);
                showToast(error.message || 'An unexpected error occurred.', 'error');
                throw error; // Re-throw the error for the calling function to handle
            } finally {
                hideLoader();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = $('#email').val();
            const password = $('#password').val();
            try {
                const result = await apiCall('/login', 'POST', { email, password });
                
                sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
                sessionStorage.setItem('authToken', result.token);
                
                // You can add logic here for `result.forceReset` if needed
                await setupUIForRole(result.user);
                
            } catch (error) {
                console.error("Login attempt failed:", error.message);
                // The toast notification is already shown by the apiCall function's catch block.
            }
        }
        
        async function handleRegistration(e) {
            e.preventDefault();
            const data = { 
                FullName: $('#reg-fullname').val(), 
                Email: $('#reg-email').val(), 
                Password: $('#reg-password').val(), 
                Role: $('#reg-role').val(), 
                CompanyName: $('#reg-company').val(), 
                ContactNumber: $('#reg-contact').val(), 
                GSTIN: $('#reg-gstin').val() 
            };
            try {
                const result = await apiCall('/register', 'POST', data);
                if (result.success) {
                    showToast(result.message, 'success');
                    registerModal.hide();
                    $(e.target)[0].reset();
                }
            } catch (error) {
                console.error("Registration attempt failed:", error.message);
            }
        }

        function handleRoleChange() {
            const isVendor = $('#reg-role').val() === 'Vendor';
            $('#reg-company-wrapper').toggleClass('hidden', !isVendor);
            $('#reg-gstin-wrapper').toggleClass('hidden', !isVendor);
            $('#reg-company').prop('required', isVendor);
        }

        function handleLogout() {
            sessionStorage.clear();
            window.location.reload();
        }

        function setupUIForRole(user) {
            loginWrapper.addClass('hidden');
            appContainer.removeClass('hidden');
            
            // NOTE: You will need to add your full `setupUIForRole` logic and all
            // other application functions (`MapsTo`, `load_..._view`, etc.) here.
            // This is just the basic setup to fix the login/register part.
            
            // For example:
            appContainer.html(`
                <div class="d-flex justify-content-center align-items-center vh-100">
                    <div>
                        <h1>Welcome, ${user.full_name}!</h1>
                        <p>Your role is: ${user.role}</p>
                        <button onclick="handleLogout()" class="btn btn-danger">Logout</button>
                    </div>
                </div>
            `);
        }
        
        // =========================================================
        // ================ UTILITY FUNCTIONS ======================
        // =========================================================
        function showToast(m, t='info') {
            const c = $('#toast-container'),
                  e = $(`<div><i class="fas ${t === 'success' ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i><span>${m}</span></div>`).addClass(`toast-notification ${t}`);
            c.append(e);
            setTimeout(() => e.remove(), 5000);
        }
        function showLoader() { $('#loader-overlay').removeClass('hidden'); }
        function hideLoader() { $('#loader-overlay').addClass('hidden'); }
    </script>
</body>
</html>
