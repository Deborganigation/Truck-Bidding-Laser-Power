<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S LOGISTICS</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/truck.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #f4f5f7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1f3866;
            --sidebar-active-text: #ffffff; --content-bg: #f8f9fe; --card-bg: #ffffff;
            --text-dark: #32325d; --text-muted: #8898aa; --border-color: #dee2e6;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; width: 350px; }
        .toast-notification { padding: 1rem 1.5rem; color: white; border-radius: 0.5rem; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: start; gap: 10px; }
        .toast-notification .toast-content { flex-grow: 1; }
        .toast-notification .toast-actions { margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        .toast-notification.warning { background: linear-gradient(87deg, #fb6340 0, #fbb140 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: rgba(255,255,255,0.7); }

        .wrapper { display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; z-index: 1001; transition: all 0.3s ease-in-out; flex-shrink: 0; }
        .sidebar .logo { font-size: 1.2rem; font-weight: 600; text-align: center; color: white; padding: 20px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .sidebar .logo i { color: var(--info-color); }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 25px; border-radius: .375rem; margin: 0 1rem 5px; transition: all 0.2s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center; justify-content: space-between;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar .nav-link.active { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; color: var(--sidebar-active-text); font-weight: 500; box-shadow: 0 4px 6px rgba(50,50,93,.11), 0 1px 3px rgba(0,0,0,.08); }
        .sidebar .nav-link .nav-link-text { display: flex; align-items: center; }
        .sidebar .nav-link .nav-link-text i { margin-right: 15px; width: 20px; text-align: center; font-size: 1rem; }
        
        .main-content-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 0.75rem 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 1000; flex-shrink: 0; }
        .main-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        #sidebar-toggle { font-size: 1.5rem; cursor: pointer; color: var(--text-dark); }
        #header-title { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); margin: 0; }
        .user-dropdown .dropdown-toggle::after { display: none; }
        .user-dropdown .dropdown-menu { border-radius: .5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); border: 1px solid var(--border-color); }
        
        .wrapper.sidebar-collapsed .sidebar { width: 80px; }
        .wrapper.sidebar-collapsed .sidebar .logo span, .wrapper.sidebar-collapsed .sidebar .nav-link-text span, .wrapper.sidebar-collapsed .sidebar .nav-link .badge { display: none; }
        .wrapper.sidebar-collapsed .sidebar .nav-link { justify-content: center; }
        .wrapper.sidebar-collapsed .sidebar .nav-link-text i { margin-right: 0; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; top: 0; height: 100vh; }
            .wrapper.sidebar-mobile-open .sidebar { left: 0; }
            .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
            .wrapper.sidebar-mobile-open .sidebar-overlay { display: block; }
        }

        .card {
            border: none;
            border-radius: .75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
        }

        .table th, .table td {
            text-align: center;
            vertical-align: middle;
        }
        .table th { white-space: nowrap; }
        .table-responsive { word-break: normal; }

        @media (max-width: 768px) {
            .table { font-size: 0.85rem; }
            .table th, .table td { padding: 0.5rem 0.4rem; }
            .card-header h5, #header-title { font-size: 1.1rem; }
            .main-content { padding: 1rem 0.75rem; }
            .top-header { padding: 0.75rem 1rem; }
        }
    </style>
</head>
<body>
    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>
    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://assets.mixkit.co/videos/preview/mixkit-highway-in-the-middle-of-a-mountain-range-4633-large.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-truck text-info"></i> DEB'S LOGISTICS</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>
    
    <div id="app-container" class="wrapper hidden"></div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Shipper">Shipper (I have loads)</option><option value="Trucker">Trucker (I have trucks)</option></select></div><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div><div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div><div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="bulk-upload-modal-title">Bulk Upload</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Please upload an Excel file. <a href="#" id="download-template-link">Download Template</a></p><hr><form id="bulk-upload-form"><input type="hidden" id="bulk-upload-type"><div class="mb-3"><label class="form-label">Select Excel File</label><input class="form-control" type="file" id="bulk-upload-file" accept=".xlsx, .xls" required></div><button type="submit" class="btn btn-primary w-100"><i class="fas fa-upload me-2"></i>Upload and Process</button></form></div></div></div></div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="add-user-form"><div class="mb-3"><label class="form-label">Role</label><select id="add-role" class="form-select" required><option value="">Select...</option><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><input type="text" id="add-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="add-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="add-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="add-contact" class="form-control" placeholder="Contact"></div><div class="mb-2"><input type="text" id="add-company" class="form-control" placeholder="Company Name"></div><div class="mb-3"><input type="text" id="add-gstin" class="form-control" placeholder="GSTIN"></div><button type="submit" class="btn btn-success w-100 fw-bold">Create User</button></form></div></div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="edit-userid"><div class="mb-2"><label>Name</label><input type="text" id="edit-fullname" class="form-control" required></div><div class="mb-2"><label>Email</label><input type="email" id="edit-email" class="form-control" required></div><div class="mb-2"><label>Role</label><select id="edit-role" class="form-select" required><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><label>Company</label><input type="text" id="edit-company" class="form-control"></div><div class="mb-2"><label>Contact</label><input type="text" id="edit-contact" class="form-control"></div><div class="mb-2"><label>GSTIN</label><input type="text" id="edit-gstin" class="form-control"></div><div class="mb-2"><label>New Password</label><input type="password" id="edit-password" class="form-control" placeholder="Leave blank to keep unchanged"></div><button type="submit" class="btn btn-success w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="masterDataModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="master-data-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="master-data-form" data-type="" data-id=""><div class="mb-3"><label>Name</label><input type="text" id="master-name" class="form-control" required></div><div id="master-active-switch" class="form-check form-switch"><input class="form-check-input" type="checkbox" id="master-active"><label class="form-check-label" for="master-active">Is Active</label></div><button type="submit" class="btn btn-success w-100 mt-3">Save</button></form></div></div></div></div>
    <div class="modal fade" id="editLoadModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Load Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-load-form"><input type="hidden" id="edit-load-id"><div class="mb-3"><label class="form-label">Loading Point</label><input type="text" id="edit-loading-point" class="form-control" required></div><div class="mb-3"><label class="form-label">Unloading Point</label><input type="text" id="edit-unloading-point" class="form-control" required></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Material</label><select id="edit-material" class="form-select" required></select></div><div class="col-md-6 mb-3"><label class="form-label">Truck Type</label><select id="edit-truck-type" class="form-select" required></select></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Weight (Tonnes)</label><input type="number" id="edit-weight" class="form-control" step="0.1" required></div><div class="col-md-6 mb-3"><label class="form-label">Requirement Date</label><input type="date" id="edit-req-date" class="form-control" required></div></div><button type="submit" class="btn btn-primary w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="bulkApproveModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Bulk Approve & Assign Loads</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>You are about to approve <strong id="bulk-approve-count"></strong> selected "Pending Approval" load(s).</p><hr><div class="mb-3"><label class="form-label fw-bold">Bidding Start Time (Mandatory)</label><input type="datetime-local" id="bulkApproveStartTime" class="form-control" required></div><div class="mb-3"><label class="form-label fw-bold">Bidding Duration (Mandatory)</label><select id="bulkApproveDuration" class="form-select" required><option value="5">5 Minutes</option><option value="10">10 Minutes</option><option value="15" selected>15 Minutes</option><option value="20">20 Minutes</option><option value="30">30 Minutes</option><option value="45">45 Minutes</option><option value="60">60 Minutes</option></select></div><div class="mb-3"><label class="form-label fw-bold d-flex justify-content-between"><span>Assign Truckers</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.bulk-approve-trucker-checkbox').prop('checked', this.checked)" checked><label class="form-check-label small">Select All</label></div></label><div id="bulk-approve-trucker-checklist" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" onclick="handleBulkApproveSubmit()">Confirm & Approve</button></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const API_BASE_URL = '/api';
        let loginWrapper, appContainer;
        let registerModal, editUserModal, addUserModal, bulkUploadModal, masterDataModal, editLoadModal, bulkApproveModal;
        let charts = {};
        
        // ===================================================================================
        // NEW AND UPDATED VIEWS
        // ===================================================================================

        const views = {
            'admin-dashboard-view': `<div class="row g-4"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Analytics Overview</h5></div><div class="card-body"><div class="row"><div class="col-lg-7 mb-4 mb-lg-0"><h6 class="text-muted text-center">Load Creation Trends</h6><div class="chart-container"><canvas id="adminLoadChart"></canvas></div></div><div class="col-lg-5"><h6 class="text-muted text-center">Top Trucker Bidding</h6><div class="chart-container"><canvas id="adminTruckerBiddingChart"></canvas></div></div></div></div></div></div></div>`,
            
            // ⭐ [UPDATED] admin-pending-loads-view now includes bulk upload and history
            'admin-pending-loads-view': `
                <div class="view">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-upload me-2 text-primary"></i>Bulk Load Upload</h5>
                                </div>
                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <p class="text-muted">Upload an Excel file to create multiple load requests at once.</p>
                                    <button class="btn btn-primary" onclick="openBulkUploadModal('load')">
                                        <i class="fas fa-file-excel me-2"></i>Upload Loads File
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-history me-2 text-info"></i>Upload History</h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="load_admin_pending_loads_view()"><i class="fas fa-sync-alt"></i></button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0" id="bulk-upload-history-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>File Name</th>
                                                    <th>Uploaded At</th>
                                                    <th>Status</th>
                                                    <th>Success</th>
                                                    <th>Failed</th>
                                                    <th>Error File</th>
                                                </tr>
                                            </thead>
                                            <tbody id="bulk-upload-history-tbody"></tbody>
                                        </table>
                                    </div>
                                    <div id="bulk-upload-history-empty-state"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between">
                            <h5 class="mb-0"><i class="fas fa-inbox me-2 text-warning"></i>Pending Individual Load Approvals</h5>
                            <button class="btn btn-sm btn-success" onclick="openBulkApproveModal()"><i class="fas fa-check-double me-2"></i>Approve Selected</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="admin-pending-loads-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th><input type="checkbox" onchange="$(this).closest('table').find('.load-checkbox').prop('checked', this.checked)"></th>
                                            <th>Inhouse Req No.</th>
                                            <th>Load ID</th>
                                            <th>Loading Point</th>
                                            <th>Unloading Point</th>
                                            <th>Material</th>
                                            <th>Truck Type</th>
                                            <th>Weight</th>
                                            <th>Req. Date</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-pending-loads-tbody"></tbody>
                                </table>
                            </div>
                            <div id="admin-pending-loads-empty-state"></div>
                        </div>
                    </div>
                </div>
            `,
            'admin-user-approvals-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">Pending User Approvals</h5></div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table></div><div id="admin-pending-users-empty-state"></div></div></div>`,
            'admin-master-data-view': `<div class="row view"><div class="col-md-6 mb-4 mb-md-0"><div class="card"><div class="card-header d-flex justify-content-between"><span>Material Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('item')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('item')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="item-master-tbody"></tbody></table></div></div></div><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>Truck Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('truck')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('truck')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="truck-master-tbody"></tbody></table></div></div></div></div>`,
        };
        
        // ===================================================================================
        // DOCUMENT READY & EVENT LISTENERS
        // ===================================================================================

        $(document).ready(() => {
            loginWrapper = $('#login-wrapper');
            appContainer = $('#app-container');
            
            try {
                registerModal = new bootstrap.Modal('#registerModal');
                bulkUploadModal = new bootstrap.Modal('#bulkUploadModal');
                addUserModal = new bootstrap.Modal('#addUserModal');
                editUserModal = new bootstrap.Modal('#editUserModal');
                masterDataModal = new bootstrap.Modal('#masterDataModal');
                editLoadModal = new bootstrap.Modal('#editLoadModal');
                bulkApproveModal = new bootstrap.Modal('#bulkApproveModal');
            } catch (e) { console.error("Error initializing modals:", e); }

            const user = sessionStorage.getItem('loggedInUser');
            if (user && sessionStorage.getItem('authToken')) {
                setupUIForRole(JSON.parse(user));
            } else {
                loginWrapper.removeClass('hidden');
                appContainer.addClass('hidden');
            }

            $('#login-form').on('submit', handleLogin);
            $('#register-form').on('submit', handleRegistration);
            $('#reg-role').on('change', handleRoleChange);
            $('#togglePassword').on('click', function() {
                const p = $('#password');
                p.attr('type', p.attr('type') === 'password' ? 'text' : 'password');
                $(this).toggleClass('fa-eye-slash fa-eye');
            });
            
            $(document).on('submit', '#bulk-upload-form', handleBulkUpload);
            $(document).on('submit', '#add-user-form', handleAddUserSubmit);
            $(document).on('submit', '#edit-user-form', handleUserUpdateSubmit);
            $(document).on('submit', '#master-data-form', handleMasterDataSubmit);
            $(document).on('submit', '#edit-load-form', handleEditLoadSubmit);
        });

        // ===================================================================================
        // CORE FUNCTIONS (API, Navigation, UI Setup)
        // ===================================================================================

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false, showLoaderFlag = true) {
            if(showLoaderFlag) showLoader();
            try {
                const headers = {};
                const token = sessionStorage.getItem('authToken');
                if (token) headers['Authorization'] = `Bearer ${token}`;
                
                const url = API_BASE_URL + endpoint;
                const options = { method, headers };

                if (body) {
                    if (isFormData) {
                        options.body = body;
                    } else {
                        headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    }
                }

                const response = await fetch(url, options);
                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 401 && !endpoint.includes('/login')) {
                        showToast('Session expired. Logging out.', 'error');
                        setTimeout(handleLogout, 2000);
                    }
                    throw new Error(result.message || 'Server error');
                }
                return result;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                if(showLoaderFlag) hideLoader();
            }
        }

        function navigateTo(viewId) {
            if (!views[viewId]) return console.error("View not found:", viewId);
            
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            $('#main-view').html(views[viewId]);
            $('#nav-links .nav-link').removeClass('active');
            const navLink = $(`[data-view="${viewId}"]`);
            if (navLink.length) {
                navLink.addClass('active');
                $('#header-title').text(navLink.find('span').text().trim());
            }
            
            const loadFunctionName = `load_${viewId.replace(/-/g, '_')}`;
            if (typeof window[loadFunctionName] === 'function') {
                window[loadFunctionName]();
            }
        }

        function setupUIForRole(user) {
            loginWrapper.addClass('hidden');
            appContainer.removeClass('hidden');
            const roleNavs = {
                'Admin': `
                    <a class="nav-link" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a>
                    <a class="nav-link" data-view="admin-pending-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-inbox"></i> <span>Load Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-loads"></span></a>
                    <a class="nav-link" data-view="admin-master-data-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-database"></i> <span>Master Data</span></div></a>
                    <a class="nav-link" data-view="admin-user-approvals-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-user-check"></i> <span>User Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-users"></span></a>
                `,
            };
            roleNavs['Super Admin'] = roleNavs['Admin'];
            
            const appHTML = `
                <nav class="sidebar" id="sidebar">
                    <div class="logo"><i class="fas fa-truck"></i> <span>DEB'S LOGISTICS</span></div>
                    <div id="nav-links" class="flex-grow-1">${roleNavs[user.role] || ''}</div>
                </nav>
                <div class="main-content-wrapper">
                    <header class="top-header">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-bars" id="sidebar-toggle" onclick="toggleSidebar()"></i>
                            <h1 id="header-title" class="h4 mb-0 fw-bold text-dark ms-3"></h1>
                        </div>
                        <div class="dropdown user-dropdown">
                            <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
                                <img src="https://img.icons8.com/color/48/user-male-circle--v1.png" alt="user" width="32" height="32" class="rounded-circle">
                            </a>
                            <ul class="dropdown-menu text-small dropdown-menu-end">
                                <li class="px-3 pt-2 pb-1">
                                    <div class="fw-bold">${user.full_name}</div>
                                    <div class="text-muted small">${user.email}</div>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </header>
                    <main class="main-content" id="main-content">
                        <div id="main-view"></div>
                    </main>
                </div>`;
            appContainer.html(appHTML);
            
            const defaultView = user.role === 'Admin' || user.role === 'Super Admin' ? 'admin-dashboard-view' : '';
            navigateTo(defaultView);
        }

        // ===================================================================================
        // PAGE LOAD FUNCTIONS (for each view)
        // ===================================================================================

        async function load_admin_dashboard_view() {
            try {
                const result = await apiCall('/admin/dashboard-stats');
                const data = result.data;
                createChart('adminLoadChart', 'bar', { labels: data.charts.loadTrends.labels, datasets: [{ label: 'Loads Created', data: data.charts.loadTrends.data, backgroundColor: '#5E72E4' }] });
                createChart('adminTruckerBiddingChart', 'doughnut', { labels: data.charts.biddingActivity.labels, datasets: [{ data: data.charts.biddingActivity.data, backgroundColor: ['#5E72E4', '#2DCE89', '#FB6340', '#11CDEF', '#F5365C'] }] });
            } catch (e) {}
        }
        
        // ⭐ [UPDATED] This function now loads both pending loads and upload history
        async function load_admin_pending_loads_view() {
            // Part 1: Load Bulk Upload History
            const historyTbody = $('#bulk-upload-history-tbody');
            const historyEmpty = $('#bulk-upload-history-empty-state');
            try {
                historyEmpty.html(renderEmptyState(null, 'Loading History...', 'fa-spinner fa-spin'));
                historyTbody.empty();
                const historyResult = await apiCall('/loads/bulk-upload-history', 'GET', null, false, false);
                
                if (historyResult.data.length === 0) {
                    historyEmpty.html(renderEmptyState(null, 'No bulk upload history found.', 'fa-history'));
                } else {
                    historyEmpty.empty();
                    historyTbody.html(historyResult.data.map(h => `
                        <tr>
                            <td><small>${h.original_filename}</small></td>
                            <td>${formatDate(h.created_at, true)}</td>
                            <td><span class="badge bg-${getUploadStatusColor(h.status)}">${h.status}</span></td>
                            <td><span class="badge bg-success">${h.successful_count}</span></td>
                            <td><span class="badge bg-danger">${h.failed_count}</span></td>
                            <td>
                                ${h.error_file_token ? `<button class="btn btn-sm btn-outline-danger" onclick="downloadBulkErrorFile('${h.error_file_token}')"><i class="fas fa-download"></i></button>` : '<span>-</span>'}
                            </td>
                        </tr>
                    `).join(''));
                }
            } catch (e) {
                historyEmpty.html(renderEmptyState(null, 'Failed to load history.', 'fa-exclamation-triangle'));
            }

            // Part 2: Load Pending Individual Loads (Existing Logic)
            const pendingTbody = $('#admin-pending-loads-tbody');
            const pendingEmpty = $('#admin-pending-loads-empty-state');
            try {
                pendingEmpty.html(renderEmptyState(null, 'Loading pending loads...', 'fa-spinner fa-spin'));
                const result = await apiCall('/admin/all-loads', 'GET', { status: 'Pending Approval' }, false, false);
                if (result.data.length === 0) {
                    pendingEmpty.html(renderEmptyState(null, 'No loads are pending approval.', 'fa-inbox'));
                    pendingTbody.empty();
                } else {
                    pendingEmpty.empty();
                    pendingTbody.html(result.data.map(l => `
                        <tr data-load-id="${l.load_id}">
                            <td><input type="checkbox" class="form-check-input load-checkbox"></td>
                            <td>${l.inhouse_req_no || '-'}</td>
                            <td>${l.load_id}</td>
                            <td>${l.loading_point_address}</td>
                            <td>${l.unloading_point_address}</td>
                            <td>${l.item_name}</td>
                            <td>${l.truck_name}</td>
                            <td>${l.approx_weight_tonnes}T</td>
                            <td>${formatDate(l.requirement_date)}</td>
                            <td>${l.remarks || '-'}</td>
                        </tr>`).join(''));
                }
            } catch (e) {
                pendingEmpty.html(renderEmptyState(null, 'Failed to load pending loads.', 'fa-exclamation-triangle'));
            }
        }

        async function load_admin_master_data_view() {
             try {
                const [items, trucks] = await Promise.all([apiCall('/master-data/items'), apiCall('/master-data/truck-types')]);
                $('#item-master-tbody').html(items.data.map(i => `<tr><td>${i.item_name}</td><td><span class="badge bg-${i.is_active ? 'success' : 'danger'}">${i.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("item", ${JSON.stringify(i)})'><i class="fas fa-edit"></i></button></td></tr>`).join(''));
                $('#truck-master-tbody').html(trucks.data.map(t => `<tr><td>${t.truck_name}</td><td><span class="badge bg-${t.is_active ? 'success' : 'danger'}">${t.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("truck", ${JSON.stringify(t)})'><i class="fas fa-edit"></i></button></td></tr>`).join(''));
            } catch (e) {}
        }
        
        async function load_admin_user_approvals_view() {
            const tbody = $('#admin-pending-users-tbody'), empty = $('#admin-pending-users-empty-state');
            try {
                empty.html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin'));
                const result = await apiCall('/users/pending');
                if (result.data.length === 0) return empty.html(renderEmptyState(null, 'No users are pending approval.', 'fa-user-check'));
                empty.empty();
                tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.company_name || '-'}</td><td>${u.contact_number || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-success" onclick="approveUser(${u.temp_id})">Approve</button> <button class="btn btn-danger" onclick="rejectUser(${u.temp_id})">Reject</button></div></td></tr>`).join(''));
            } catch (e) {}
        }

        // ===================================================================================
        // HANDLER FUNCTIONS (Forms, Clicks)
        // ===================================================================================
        
        async function handleLogin(e) { e.preventDefault(); try { const result = await apiCall('/login', 'POST', { email: $('#email').val(), password: $('#password').val() }); sessionStorage.setItem('loggedInUser', JSON.stringify(result.user)); sessionStorage.setItem('authToken', result.token); await setupUIForRole(result.user); } catch (error) {} }
        async function handleRegistration(e) { e.preventDefault(); try { await apiCall('/register', 'POST', { FullName: $('#reg-fullname').val(), Email: $('#reg-email').val(), Password: $('#reg-password').val(), Role: $('#reg-role').val(), CompanyName: $('#reg-company').val(), ContactNumber: $('#reg-contact').val(), GSTIN: $('#reg-gstin').val() }); showToast('Registration successful! Awaiting admin approval.', 'success'); registerModal.hide(); e.target.reset(); } catch (e) {} }
        
        // ⭐ [UPDATED] Bulk upload handler with detailed feedback
        async function handleBulkUpload(e) {
            e.preventDefault();
            const file = $('#bulk-upload-file')[0].files[0];
            if (!file) return showToast('Please select a file.', 'error');
            const type = $('#bulk-upload-type').val();
            const endpoint = type === 'load' ? '/loads/bulk-upload' : `/master-data/${type}s/bulk-upload`;
            
            const formData = new FormData();
            formData.append('bulkFile', file);
            
            try {
                // The API is expected to return a detailed response now
                const result = await apiCall(endpoint, 'POST', formData, true);
                bulkUploadModal.hide();
                
                // Show detailed toast based on the result
                let toastType = 'info';
                if (result.failed_count === 0 && result.successful_count > 0) {
                    toastType = 'success';
                } else if (result.failed_count > 0 && result.successful_count > 0) {
                    toastType = 'warning';
                } else if (result.failed_count > 0 && result.successful_count === 0) {
                    toastType = 'error';
                }
                
                showToast(result.message || 'File processed.', toastType, 8000);

                // Refresh the page to show history and new pending loads
                if ($('#bulk-upload-history-table').length) {
                    load_admin_pending_loads_view();
                }

            } catch (e) {
                // This catch block will handle network errors or 500-level server errors
                bulkUploadModal.hide();
                showToast('A critical error occurred during upload. Please try again.', 'error');
            } finally {
                 $('#bulk-upload-form')[0].reset();
            }
        }

        async function handleAddUserSubmit(e) { e.preventDefault(); const data = { full_name: $('#add-fullname').val(), email: $('#add-email').val(), password: $('#add-password').val(), role: $('#add-role').val(), company_name: $('#add-company').val(), contact_number: $('#add-contact').val(), gstin: $('#add-gstin').val() }; try { await apiCall('/users', 'POST', data); showToast('User created!', 'success'); addUserModal.hide(); e.target.reset(); load_admin_user_control_view(); } catch (e) {} }
        async function handleUserUpdateSubmit(e) { e.preventDefault(); const id = $('#edit-userid').val(), data = { full_name: $('#edit-fullname').val(), email: $('#edit-email').val(), role: $('#edit-role').val(), company_name: $('#edit-company').val(), contact_number: $('#edit-contact').val(), gstin: $('#edit-gstin').val(), password: $('#edit-password').val() }; try { await apiCall(`/users/${id}`, 'PUT', data); showToast('User updated!', 'success'); editUserModal.hide(); load_admin_user_control_view(); } catch (e) {} }
        async function handleMasterDataSubmit(e) { e.preventDefault(); const form = $(e.currentTarget), type = form.data('type'), id = form.data('id'), isEdit = !!id; const name = $('#master-name').val(), isActive = $('#master-active').is(':checked'); const endpoint = isEdit ? `/master-data/${type}s/${id}` : `/master-data/${type}s`; const method = isEdit ? 'PUT' : 'POST'; const body = isEdit ? { name, is_active: isActive } : { name }; try { await apiCall(endpoint, method, body); showToast(`${type} data saved!`, 'success'); masterDataModal.hide(); load_admin_master_data_view(); } catch (e) {} }
        async function handleEditLoadSubmit(e) { e.preventDefault(); const loadId = $('#edit-load-id').val(); const data = { loading_point_address: $('#edit-loading-point').val(), unloading_point_address: $('#edit-unloading-point').val(), item_id: $('#edit-material').val(), truck_type_id: $('#edit-truck-type').val(), approx_weight_tonnes: $('#edit-weight').val(), requirement_date: $('#edit-req-date').val() }; try { await apiCall(`/loads/${loadId}`, 'PUT', data); showToast('Load updated!', 'success'); editLoadModal.hide(); load_admin_manage_loads_view(); } catch (error) {} }

        // ===================================================================================
        // MODAL & HELPER FUNCTIONS
        // ===================================================================================
        
        function openBulkUploadModal(type) {
            $('#bulk-upload-modal-title').text(`Bulk Upload ${type === 'load' ? 'Loads' : (type === 'item' ? 'Materials' : 'Truck Types')}`);
            $('#download-template-link').off('click').on('click', () => downloadBulkTemplate(type));
            $('#bulk-upload-type').val(type);
            $('#bulk-upload-form')[0].reset();
            bulkUploadModal.show();
        }

        // ⭐ [NEW] Function to trigger download of the error file
        function downloadBulkErrorFile(token) {
            const url = `${API_BASE_URL}/downloads/bulk-error?token=${token}`;
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.setAttribute('download', ''); // Lets the browser determine the filename from Content-Disposition header
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Downloading error report...', 'info');
        }

        function downloadBulkTemplate(type) {
            let data, filename;
            if (type === 'load') {
                data = [{ "LoadingPoint": "City A", "UnloadingPoint": "City B", "MaterialName": "STEEL ITEMS", "TruckName": "10 Wheeler Truck", "WeightInTonnes": 15, "RequirementDate": "2025-10-25", "InhouseRequestionNo": "REQ-123", "Remarks": "Urgent delivery" }];
                filename = "Bulk_Load_Template.xlsx";
            } else {
                data = [{ "Name": `Sample ${type === 'item' ? 'Material' : 'Truck'}` }];
                filename = `Bulk_${type}_Template.xlsx`;
            }
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, filename);
        }

        async function openBulkApproveModal() {
            const selectedLoads = $('#admin-pending-loads-table .load-checkbox:checked').map(function() {
                return $(this).closest('tr').data('load-id');
            }).get();
            if (selectedLoads.length === 0) return showToast('Please select at least one load.', 'warning');
            
            $('#bulk-approve-count').text(selectedLoads.length);
            const checklistDiv = $('#bulk-approve-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin'));
            bulkApproveModal.show();
            
            try {
                const result = await apiCall('/users/truckers', 'GET', null, false, false);
                const truckersHtml = result.data.map(t => `<div class="form-check"><input class="form-check-input bulk-approve-trucker-checkbox" type="checkbox" value="${t.user_id}" id="ba-t-${t.user_id}" checked><label class="form-check-label" for="ba-t-${t.user_id}">${t.full_name}</label></div>`).join('');
                checklistDiv.html(truckersHtml || '<p class="text-muted">No truckers found.</p>');
            } catch (e) {
                checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>');
            }
        }

        async function handleBulkApproveSubmit() {
            const loadIds = $('#admin-pending-loads-table .load-checkbox:checked').map(function() { return $(this).closest('tr').data('load-id'); }).get();
            const truckerIds = $('#bulk-approve-trucker-checklist .bulk-approve-trucker-checkbox:checked').map((i, el) => $(el).val()).get();
            const biddingStartTime = $('#bulkApproveStartTime').val(), biddingDurationMinutes = $('#bulkApproveDuration').val();
            if (loadIds.length === 0 || !biddingStartTime || truckerIds.length === 0) return showToast('Please select loads, set a start time, and assign truckers.', 'error');
            try {
                await apiCall('/loads/bulk-approve', 'POST', { loadIds, truckerIds, biddingStartTime, biddingDurationMinutes });
                showToast(`${loadIds.length} loads approved and assigned.`, 'success');
                bulkApproveModal.hide();
                navigateTo('admin-pending-loads-view');
            } catch (e) {}
        }

        async function approveUser(id) { if (confirm('Approve user?')) { try { await apiCall('/users/approve', 'POST', { temp_id: id }); showToast('User Approved!', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        async function rejectUser(id) { if (confirm('Reject user?')) { try { await apiCall(`/pending-users/${id}`, 'DELETE'); showToast('User Rejected.', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        function openAddUserModal() { $('#add-user-form')[0].reset(); addUserModal.show(); }
        function openEditUserModal(u) { $('#edit-userid').val(u.user_id); $('#edit-fullname').val(u.full_name); $('#edit-email').val(u.email); $('#edit-role').val(u.role); $('#edit-company').val(u.company_name || ''); $('#edit-contact').val(u.contact_number || ''); $('#edit-gstin').val(u.gstin || ''); $('#edit-password').val(''); editUserModal.show(); }
        function openMasterDataModal(type, data = null) { const isEdit = data !== null; $('#master-data-modal-title').text(`${isEdit ? 'Edit' : 'Add'} ${type === 'item' ? 'Material' : 'Truck Type'}`); const form = $('#master-data-form'); form.data('type', type); form.data('id', isEdit ? (data.item_id || data.truck_type_id) : ''); $('#master-name').val(isEdit ? (data.item_name || data.truck_name) : ''); $('#master-active-switch').toggle(isEdit).find('input').prop('checked', isEdit && data.is_active); masterDataModal.show(); }

        // ===================================================================================
        // UTILITY FUNCTIONS
        // ===================================================================================
        
        // ⭐ [UPDATED] Toast function can now accept a longer duration
        function showToast(message, type = 'info', duration = 4000) {
            const iconClass = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' }[type] || 'fa-info-circle';
            const toastElement = $(`
                <div class="toast-notification ${type}">
                    <i class="fas ${iconClass} mt-1"></i>
                    <div class="toast-content">${message}</div>
                </div>`);
            $('#toast-container').append(toastElement);
            setTimeout(() => toastElement.remove(), duration);
        }

        function showLoader() { $('#loader-overlay').removeClass('hidden'); }
        function hideLoader() { $('#loader-overlay').addClass('hidden'); }
        function renderEmptyState(container, message, iconClass = 'fa-folder-open') { const html = `<div class="text-center p-5 text-muted"><i class="fas ${iconClass} fa-3x mb-3"></i><p>${message}</p></div>`; if (container) container.html(html); return html; }
        function formatDate(d, includeTime = false) { if (!d) return 'N/A'; try { const date = new Date(d.replace(' ', 'T') + 'Z'); const options = { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Kolkata' }; if (includeTime) { options.hour = 'numeric'; options.minute = '2-digit'; options.hour12 = true; } return new Intl.DateTimeFormat('en-IN', options).format(date); } catch (e) { return 'Invalid Date'; } }
        function getUploadStatusColor(status) { return { 'Completed': 'success', 'Partial Failure': 'warning', 'Failed': 'danger' }[status] || 'secondary'; }
        function createChart(chartId, type, data, options = {}) { if (charts[chartId]) charts[chartId].destroy(); const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return; charts[chartId] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } }); }
        function handleLogout() { sessionStorage.clear(); window.location.reload(); }
        function toggleSidebar() { $('#app-container').toggleClass(window.innerWidth <= 768 ? 'sidebar-mobile-open' : 'sidebar-collapsed'); }
        function handleRoleChange() { const isTrucker = $('#reg-role').val() === 'Trucker'; $('#reg-company-wrapper, #reg-gstin-wrapper').toggleClass('hidden', !isTrucker).find('input').prop('required', isTrucker); }

    </script>
</body>
</html>
