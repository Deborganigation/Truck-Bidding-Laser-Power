<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S LOGISTICS</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/truck.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #F4F5F7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1F3866;
            --sidebar-active-text: #ffffff; --content-bg: #F8F9FE; --card-bg: #ffffff;
            --text-dark: #32325D; --text-muted: #8898AA; --border-color: #E9ECEF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        #login-container a { color: var(--info-color); }
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: rgba(255,255,255,0.7); }
        .wrapper { display: flex; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transition: all 0.3s ease-in-out; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
        .sidebar .logo { font-size: 1.2rem; font-weight: 600; text-align: center; color: white; padding: 22px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar .logo i { color: var(--info-color); }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 25px; border-radius: .375rem; margin: 0 1rem 5px; transition: all 0.2s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center; justify-content: space-between;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar .nav-link.active { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; color: var(--sidebar-active-text); font-weight: 500; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); }
        .sidebar .nav-link .nav-link-text { display: flex; align-items: center; }
        .sidebar .nav-link .nav-link-text i { margin-right: 15px; width: 20px; text-align: center; font-size: .95rem; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 10px; text-align: center; }
        .main-content { width: 100%; padding: 30px; margin-left: 260px; transition: margin-left 0.3s ease-in-out; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: transparent; padding: 0; margin-bottom: 30px; }
        .sidebar-toggle-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-dark); }
        .stat-card { border: none; border-radius: .5rem; color: white; padding: 25px; box-shadow: 0 15px 35px rgba(50,50,93,.1), 0 5px 15px rgba(0,0,0,.07) !important; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .display-4 { font-weight: 600; }
        .stat-card i.stat-icon { font-size: 3.5rem; opacity: 0.3; transform: rotate(-15deg); }
        .bg-gradient-primary { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; }
        .bg-gradient-success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .bg-gradient-warning { background: linear-gradient(87deg, #fb6340 0, #fbb140 100%) !important; }
        .bg-gradient-info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        .card { border: none; border-radius: .5rem; box-shadow: 0 1px 3px rgba(50,50,93,.15), 0 1px 0 rgba(0,0,0,.02); }
        .card-header { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); font-weight: 600; padding: 1.25rem 1.5rem; }
        .card-body { padding: 1.5rem; }
        .table-hover>tbody>tr:hover>* { background-color: #f6f9fc; }
        .bidding-card { border: 1px solid var(--border-color); border-radius: .5rem; overflow: hidden; }
        .bidding-card .card-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .bidding-card .bid-input-area { background-color: #f8f9fe; border-top: 1px solid var(--border-color); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; }
        .chart-container { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://assets.mixkit.co/videos/preview/mixkit-highway-in-the-middle-of-a-mountain-range-4633-large.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-truck text-info"></i> DEB'S LOGISTICS</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>

    <div id="app-container" class="wrapper hidden">
        </div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Shipper">Shipper (I have loads to transport)</option><option value="Trucker">Trucker (I have trucks)</option></select></div><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div><div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company / Transporter Name"></div><div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Bulk Upload Loads</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Please upload an Excel file (.xlsx) with the required columns. <a href="#" onclick="downloadBulkTemplate()">Download Template</a></p><hr><form id="bulk-upload-form"><div class="mb-3"><label for="bulk-upload-file" class="form-label">Select Excel File</label><input class="form-control" type="file" id="bulk-upload-file" accept=".xlsx, .xls" required></div><button type="submit" class="btn btn-success w-100">Upload and Submit</button></form></div></div></div></div>
    <div class="modal fade" id="adminActionModal" tabindex="-1"></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"></div>
    <div class="modal fade" id="addUserModal" tabindex="-1"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // =========================================================
        // ================ CONFIG & STATE =========================
        // =========================================================
        const API_BASE_URL = '/api';
        let loginWrapper, appContainer;
        let registerModal, adminActionModal, editUserModal, addUserModal, bulkUploadModal;
        let charts = {}; // To hold chart instances

        const views = {
            'shipper-create-load-view': `
                <div class="card view">
                    <div class="card-header"><h5 class="mb-0"><i class="fas fa-truck-loading me-2"></i>Post a New Load Requirement</h5></div>
                    <div class="card-body">
                        <form id="load-request-form">
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Loading Point (Origin)</label><input type="text" id="loading_point_address" class="form-control" required placeholder="e.g., Kolkata Port, Gate 5"></div>
                                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Unloading Point (Destination)</label><input type="text" id="unloading_point_address" class="form-control" required placeholder="e.g., Delhi Warehouse, Okhla"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Material/Item Type</label><select id="item_id" class="form-select" required></select></div>
                                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Required Truck Type</label><select id="truck_type_id" class="form-select" required></select></div>
                            </div>
                            <div class="row">
                               <div class="col-md-6 mb-3"><label class="form-label fw-bold">Approximate Weight (in Tonnes)</label><input type="number" id="approx_weight_tonnes" class="form-control" step="0.1" required placeholder="e.g., 16.5"></div>
                                <div class="col-md-6 mb-3"><label class="form-label fw-bold">Requirement Date</label><input type="date" id="requirement_date" class="form-control" required></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 fw-bold py-2">Submit Load Request for Approval</button>
                        </form>
                    </div>
                </div>`,
            'shipper-status-view': `
                <div class="card view"><div class="card-header"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Load Request Status</h5></div><div class="card-body" id="shipper-req-status-list"></div></div>`,
            'trucker-dashboard-view': `
                <div class="row g-4 mb-4 view">
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Open for Bidding</h5><p class="display-4" id="trucker-stats-open">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="trucker-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('trucker-awarded-contracts-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="trucker-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Needs My Bid</h5><p class="display-4" id="trucker-stats-needs-bid">--</p></div><i class="fas fa-edit stat-icon"></i></div></div>
                </div>`,
            'trucker-open-loads-view': `
                <div class="view"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><h5 class="mb-0">Open Loads for Bidding</h5><button class="btn btn-success" onclick="handleBulkBidSubmit()"><i class="fas fa-check-double me-2"></i>Submit All Entered Bids</button></div><div id="trucker-bidding-container" class="d-grid gap-4"></div></div>`,
            'trucker-awarded-contracts-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">My Awarded Contracts</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>Route</th><th>Awarded Amount</th><th>Date</th></tr></thead><tbody id="trucker-awarded-tbody"></tbody></table><div id="trucker-awarded-empty-state"></div></div></div>`,
            'admin-dashboard-view': `
                <div class="row g-4 mb-4 view">
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary"><div><h5 class="mb-0">Active Loads</h5><p class="display-4" id="stats-active-loads">--</p></div><i class="fas fa-truck stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('admin-user-approvals-view')"><div><h5 class="mb-0">Pending Users</h5><p class="display-4" id="stats-pending-users">--</p></div><i class="fas fa-user-check stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('admin-pending-loads-view')"><div><h5 class="mb-0">Pending Loads</h5><p class="display-4" id="stats-pending-loads">--</p></div><i class="fas fa-inbox stat-icon"></i></div></div>
                    <div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('admin-awarded-contracts-view')"><div><h5 class="mb-0">Loads Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div>
                </div>
                <div class="text-end mb-3"><button class="btn btn-primary" onclick="openBulkUploadModal()"><i class="fas fa-upload me-2"></i>Bulk Upload Loads</button></div>`,
            'admin-pending-loads-view': `
                <div class="card view"><div class="card-header"><h5 class="mb-0">Pending Load Approvals</h5></div><div class="card-body"><div id="pending-loads-accordion-container"></div></div></div>`,
            'admin-awarded-contracts-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">All Awarded Contracts</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>Route</th><th>Trucker</th><th>Awarded Amount</th><th>Date</th></tr></thead><tbody id="admin-awarded-tbody"></tbody></table><div id="admin-awarded-empty-state"></div></div></div>`,
            'admin-reports-view': `
                <div class="card view">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">Reports & Analytics</h5>
                        <button class="btn btn-sm btn-success" onclick="downloadReport()"><i class="fas fa-download me-2"></i>Download Report</button>
                    </div>
                    <div class="card-body">
                         <div class="row g-3 align-items-center border p-3 rounded mb-4">
                            <div class="col-md-5"><label class="form-label-sm">Start Date</label><input type="date" id="report-start-date" class="form-control form-control-sm"></div>
                            <div class="col-md-5"><label class="form-label-sm">End Date</label><input type="date" id="report-end-date" class="form-control form-control-sm"></div>
                            <div class="col-md-2 d-grid"><button id="report-apply-filter" class="btn btn-primary btn-sm mt-md-3">Apply</button></div>
                        </div>
                        <div class="row g-4" id="report-kpis"></div>
                        <div class="mt-4"><h5 class="text-center text-muted">Detailed Report</h5><div class="table-responsive"><table class="table table-sm table-striped" id="detailed-report-table"><thead><tr><th>Load ID</th><th>Route</th><th>Material</th><th>Trucker</th><th>Awarded Amount</th><th>Award Date</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>`,
            'admin-user-approvals-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">Pending User Approvals</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table><div id="admin-pending-users-empty-state"></div></div></div>`,
            'admin-user-control-view': `<div class="card view"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">User Control Center</h5><button class="btn btn-success btn-sm" onclick="openAddUserModal()"><i class="fas fa-plus me-2"></i>Add User</button></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>GSTIN</th><th>Action</th></tr></thead><tbody id="admin-users-tbody"></tbody></table><div id="admin-users-empty-state"></div></div></div>`,
        };
        
        // =========================================================
        // ================ CORE APP LOGIC =========================
        // =========================================================
        $(document).ready(() => {
            loginWrapper = $('#login-wrapper'); appContainer = $('#app-container');
            try {
                registerModal = new bootstrap.Modal('#registerModal');
                bulkUploadModal = new bootstrap.Modal('#bulkUploadModal');
                adminActionModal = new bootstrap.Modal('#adminActionModal');
                editUserModal = new bootstrap.Modal('#editUserModal');
                addUserModal = new bootstrap.Modal('#addUserModal');
            } catch (e) { console.error("Error initializing modals:", e); }

            const user = sessionStorage.getItem('loggedInUser');
            if (user && sessionStorage.getItem('authToken')) {
                setupUIForRole(JSON.parse(user));
            } else {
                loginWrapper.removeClass('hidden');
                appContainer.addClass('hidden');
            }
            
            $('#login-form').on('submit', handleLogin);
            $('#register-form').on('submit', handleRegistration);
            $('#reg-role').on('change', handleRoleChange);
            $('#togglePassword').on('click', function() { const p = $('#password'); p.attr('type', p.attr('type') === 'password' ? 'text' : 'password'); $(this).toggleClass('fa-eye-slash fa-eye'); });
            $(document).on('submit', '#load-request-form', handleLoadSubmit);
            $(document).on('submit', '#add-user-form', handleAddUserSubmit);
            $(document).on('submit', '#edit-user-form', handleUserUpdateSubmit);
            $(document).on('submit', '#bulk-upload-form', handleBulkUpload);
            $(document).on('click', '#report-apply-filter', load_admin_reports_view);
        });

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false) {
            showLoader();
            try {
                const headers = {};
                const token = sessionStorage.getItem('authToken');
                if (token) headers['Authorization'] = `Bearer ${token}`;
                if (!isFormData) headers['Content-Type'] = 'application/json';
                const options = { method, headers };
                if (body) options.body = isFormData ? body : JSON.stringify(body);
                const response = await fetch(API_BASE_URL + endpoint, options);
                const result = await response.json();
                if (!response.ok) {
                    if (response.status === 401 && !endpoint.includes('/login')) {
                        showToast('Session expired. Logging out.', 'error');
                        setTimeout(handleLogout, 2000);
                    }
                    throw new Error(result.message || 'Server error');
                }
                return result;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                hideLoader();
            }
        }

        function navigateTo(viewId) {
            if (!views[viewId]) return console.error("View not found:", viewId);
            // Destroy any existing charts before loading a new view
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            $('#main-view').html(views[viewId]);
            $('#nav-links .nav-link').removeClass('active');
            const navLink = $(`[data-view="${viewId}"]`);
            if (navLink.length) {
                navLink.addClass('active');
                $('#header-title').text(navLink.find('span').text().trim());
            }
            const loadFunctionName = `load_${viewId.replace(/-/g, '_')}`;
            if (typeof window[loadFunctionName] === 'function') {
                window[loadFunctionName]();
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            try {
                const result = await apiCall('/login', 'POST', { email: $('#email').val(), password: $('#password').val() });
                sessionStorage.setItem('loggedInUser', JSON.stringify(result.user));
                sessionStorage.setItem('authToken', result.token);
                await setupUIForRole(result.user);
            } catch (error) { /* Toast is shown in apiCall */ }
        }

        function handleLogout() {
            sessionStorage.clear();
            window.location.reload();
        }

        function handleRoleChange() {
            const isTrucker = $('#reg-role').val() === 'Trucker';
            $('#reg-company-wrapper, #reg-gstin-wrapper').toggleClass('hidden', !isTrucker);
            $('#reg-company').prop('required', isTrucker);
        }
        
        async function handleRegistration(e) {
            e.preventDefault();
            const data = { FullName: $('#reg-fullname').val(), Email: $('#reg-email').val(), Password: $('#reg-password').val(), Role: $('#reg-role').val(), CompanyName: $('#reg-company').val(), ContactNumber: $('#reg-contact').val(), GSTIN: $('#reg-gstin').val() };
            try {
                const result = await apiCall('/register', 'POST', data);
                showToast(result.message, 'success');
                registerModal.hide();
                $(e.target)[0].reset();
            } catch (error) { /* Toast is shown in apiCall */ }
        }

        function setupUIForRole(user) {
            loginWrapper.addClass('hidden');
            appContainer.removeClass('hidden');

            const roleNavs = {
                'Shipper': `
                    <a class="nav-link" data-view="shipper-create-load-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-plus-circle"></i> <span>Post a New Load</span></div></a>
                    <a class="nav-link" data-view="shipper-status-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>My Load Status</span></div></a>`,
                'Trucker': `
                    <a class="nav-link" data-view="trucker-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a>
                    <a class="nav-link" data-view="trucker-open-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-truck-loading"></i> <span>Open Loads</span></div></a>
                    <a class="nav-link" data-view="trucker-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>My Contracts</span></div></a>`,
                'Admin': `
                    <a class="nav-link" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a>
                    <a class="nav-link" data-view="admin-pending-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-inbox"></i> <span>Load Approvals</span></div></a>
                    <a class="nav-link" data-view="admin-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>Awarded Contracts</span></div></a>
                    <a class="nav-link" data-view="admin-reports-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-chart-line"></i> <span>Reports</span></div></a>
                    <a class="nav-link" data-view="admin-user-approvals-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-user-check"></i> <span>User Approvals</span></div></a>
                    <a class="nav-link" data-view="admin-user-control-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-users-cog"></i> <span>User Control</span></div></a>`,
            };
            roleNavs['Super Admin'] = roleNavs['Admin'];

            const appHTML = `
                <nav class="sidebar" id="sidebar">
                    <div class="logo"><i class="fas fa-truck"></i> <span>DEB'S LOGISTICS</span></div>
                    <div id="nav-links" class="flex-grow-1"></div>
                    <div class="user-profile">
                        <div><h6 id="user-name-sidebar" class="mb-0 text-white">${user.full_name}</h6><small id="user-email-sidebar" class="text-muted">${user.email}</small></div>
                        <button onclick="handleLogout()" class="btn btn-sm btn-outline-danger w-100 mt-2"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
                    </div>
                </nav>
                <main class="main-content" id="main-content">
                    <div class="top-header">
                        <h1 id="header-title" class="h4 mb-0 fw-bold text-dark"></h1>
                        <button class="btn btn-sm btn-outline-primary" onclick="handleManualRefresh()"><i class="fas fa-sync-alt me-1"></i>Refresh</button>
                    </div>
                    <div id="main-view"></div>
                </main>`;
            
            appContainer.html(appHTML);
            $('#nav-links').html(roleNavs[user.role] || '');
            
            const defaultViewMap = { 'Shipper': 'shipper-create-load-view', 'Trucker': 'trucker-dashboard-view', 'Admin': 'admin-dashboard-view', 'Super Admin': 'admin-dashboard-view' };
            navigateTo(defaultViewMap[user.role]);
        }
        
        async function handleManualRefresh() {
            const currentViewLink = $('#nav-links .nav-link.active');
            if (currentViewLink.length > 0) {
                showToast('Refreshing data...', 'info');
                navigateTo(currentViewLink.data('view'));
            }
        }
        
        // =========================================================
        // ================ SHIPPER FUNCTIONS ======================
        // =========================================================
        async function load_shipper_create_load_view() {
            try {
                const [trucks, items] = await Promise.all([apiCall('/master-data/truck-types'), apiCall('/master-data/items')]);
                $('#truck_type_id').html('<option value="">Select Truck Type...</option>' + trucks.data.map(t => `<option value="${t.truck_type_id}">${t.truck_name}</option>`).join('')).select2({ theme: 'bootstrap-5', placeholder: 'Select Truck Type...' });
                $('#item_id').html('<option value="">Select Material...</option>' + items.data.map(i => `<option value="${i.item_id}">${i.item_name}</option>`).join('')).select2({ theme: 'bootstrap-5', placeholder: 'Select Material...' });
                const today = new Date().toISOString().split('T')[0];
                $('#requirement_date').attr('min', today).val(today);
            } catch (error) { $('#load-request-form').html('<div class="alert alert-danger">Could not load required data. Please refresh the page.</div>'); }
        }

        async function handleLoadSubmit(e) {
            e.preventDefault();
            const loadData = { loading_point_address: $('#loading_point_address').val(), unloading_point_address: $('#unloading_point_address').val(), item_id: $('#item_id').val(), truck_type_id: $('#truck_type_id').val(), approx_weight_tonnes: $('#approx_weight_tonnes').val(), requirement_date: $('#requirement_date').val() };
            try {
                await apiCall('/loads', 'POST', { items: JSON.stringify([loadData]) });
                showToast('Load request submitted successfully!', 'success');
                navigateTo('shipper-create-load-view');
            } catch(error) { /* Handled */ }
        }

        async function load_shipper_status_view() {
            const listDiv = $('#shipper-req-status-list');
            try {
                renderEmptyState(listDiv, 'Loading your requests...', 'fa-spinner fa-spin');
                const result = await apiCall('/requisitions/my-status');
                if (result.data.length === 0) return renderEmptyState(listDiv, 'You have not posted any loads yet.', 'fa-file-signature');
                listDiv.html('');
                result.data.forEach(req => {
                    const loadsHTML = req.loads.map(load => `<li class="list-group-item"><div class="d-flex w-100 justify-content-between"><div class="me-3"><h6 class="mb-0">${load.item_name}</h6><small>${load.loading_point_address} <i class="fas fa-long-arrow-alt-right"></i> ${load.unloading_point_address}</small></div><span class="badge bg-${getBadgeColor(load.status)} align-self-center">${load.status}</span></div>${load.status === 'Awarded' ? `<small class="d-block text-success mt-1"><i class="fas fa-trophy me-1"></i>Awarded to: ${load.awarded_vendor || 'N/A'} for <strong>${formatCurrency(load.awarded_amount)}</strong></small>` : ''}</li>`).join('');
                    listDiv.append(`<div class="card mb-3 view"><div class="card-header d-flex justify-content-between"><strong>Req ID: REQ-${req.requisition_id}</strong><small>${formatDate(req.created_at)}</small></div><ul class="list-group list-group-flush">${loadsHTML}</ul></div>`);
                });
            } catch (error) { /* Handled */ }
        }

        // =========================================================
        // ================ TRUCKER FUNCTIONS ======================
        // =========================================================
        async function load_trucker_dashboard_view() { try { const result = await apiCall('/trucker/dashboard-stats'); $('#trucker-stats-open').text(result.data.assignedLoads||'0'); $('#trucker-stats-submitted').text(result.data.submittedBids||'0'); $('#trucker-stats-won').text(result.data.contractsWon||'0'); $('#trucker-stats-needs-bid').text(result.data.needsBid||'0'); } catch(e){} }

        async function load_trucker_open_loads_view() {
            const container = $('#trucker-bidding-container');
            try {
                renderEmptyState(container, 'Loading open loads...', 'fa-spinner fa-spin');
                const result = await apiCall('/loads/assigned');
                if (result.data.length === 0) return renderEmptyState(container, 'No loads are currently assigned for bidding.', 'fa-truck-loading');
                container.html(result.data.map(load => `<div class="card bidding-card" data-load-id="${load.load_id}"><div class="card-header bg-light d-flex justify-content-between flex-wrap gap-2"><h6 class="mb-0">Load ID: ${load.load_id}</h6><span class="badge bg-${load.my_rank ? 'primary' : 'secondary'}">My Rank: ${load.my_rank ? `L${load.my_rank}` : 'Not Bid'}</span></div><div class="card-body"><div><small class="text-muted d-block">Route</small><strong>${load.loading_point_address} <i class="fas fa-arrow-right"></i> ${load.unloading_point_address}</strong></div><div><small class="text-muted d-block">Material</small><strong>${load.item_name}</strong></div><div><small class="text-muted d-block">Weight</small><strong>${load.approx_weight_tonnes} T</strong></div><div><small class="text-muted d-block">Vehicle</small><strong>${load.truck_name}</strong></div><div><small class="text-muted d-block">Date</small><strong>${formatDate(load.requirement_date)}</strong></div></div><div class="bid-input-area p-3">${(load.bid_attempts || 0) >= 3 ? `<div class="text-center text-danger small p-3"><i class="fas fa-exclamation-circle me-1"></i> Max 3 bids reached.</div>` : `<div class="input-group"><span class="input-group-text">₹</span><input type="number" step="100" class="form-control bid-amount-input" placeholder="Your Total Bid (Attempt ${ (load.bid_attempts || 0) + 1})"></div>`}</div></div>`).join(''));
            } catch(error) { /* Handled */ }
        }
        
        async function handleBulkBidSubmit() {
            const bids = $('.bidding-card').map(function() { const input = $(this).find('.bid-amount-input'); if (input.length && input.val()) return { loadId: $(this).data('load-id'), bid_amount: parseFloat(input.val()) }; }).get();
            if (bids.length === 0) return showToast('No new valid bids were entered.', 'info');
            try { await apiCall('/bids', 'POST', { bids }); showToast('Bids submitted successfully!', 'success'); load_trucker_open_loads_view(); } catch(error) { /* Handled */ }
        }

        async function load_trucker_awarded_contracts_view() {
            const tbody = $('#trucker-awarded-tbody'), empty = $('#trucker-awarded-empty-state');
            try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/trucker/awarded-contracts'); if (result.data.length === 0) return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy'); tbody.html(result.data.map(c => `<tr><td>${c.load_id}</td><td><small>${c.loading_point_address} <i class="fas fa-arrow-right"></i> ${c.unloading_point_address}</small></td><td><strong>${formatCurrency(c.awarded_amount)}</strong></td><td>${formatDate(c.awarded_date)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch(e){}
        }

        // =========================================================
        // ================== ADMIN FUNCTIONS ======================
        // =========================================================
        async function load_admin_dashboard_view() { try { const result = await apiCall('/admin/dashboard-stats'); $('#stats-active-loads').text(result.data.activeLoads||'0'); $('#stats-pending-users').text(result.data.pendingUsers||'0'); $('#stats-pending-loads').text(result.data.pendingLoads||'0'); $('#stats-awarded-contracts').text(result.data.awardedContracts||'0'); } catch(e){} }
        
        async function load_admin_pending_loads_view() {
            const container = $('#pending-loads-accordion-container');
            try {
                renderEmptyState(container, 'Loading pending approvals...', 'fa-spinner fa-spin');
                const result = await apiCall('/loads/pending');
                if (result.data.groupedReqs.length === 0) return renderEmptyState(container, 'No loads are pending approval.', 'fa-inbox');
                const { groupedReqs, pendingLoads, allTruckers } = result.data;
                const accordion = $('<div class="accordion"></div>');
                groupedReqs.forEach(req => {
                    const reqLoads = pendingLoads.filter(load => load.requisition_id == req.requisition_id);
                    if(reqLoads.length === 0) return;
                    const loadsHTML = reqLoads.map(load => `<li class="list-group-item"><input class="form-check-input me-2 load-check-box" type="checkbox" value="${load.load_id}" checked><label class="form-check-label"><strong>${load.item_name}</strong> from ${load.loading_point_address} to ${load.unloading_point_address}<small class="text-muted d-block">Vehicle: ${load.truck_name} | Weight: ${load.approx_weight_tonnes}T | Date: ${formatDate(load.requirement_date)}</small></label></li>`).join('');
                    const truckersHTML = allTruckers.map(v => `<div class="form-check form-check-inline col-md-3"><input class="form-check-input trucker-assign-check" type="checkbox" value="${v.user_id}" id="v-${req.requisition_id}-${v.user_id}"><label class="form-check-label" for="v-${req.requisition_id}-${v.user_id}">${v.full_name}</label></div>`).join('');
                    accordion.append(`<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${req.requisition_id}">Req ID: REQ-${req.requisition_id} (By: ${req.creator}) - ${reqLoads.length} Load(s)</button></h2><div id="collapse-${req.requisition_id}" class="accordion-collapse collapse"><div class="accordion-body"><h6>Select loads to approve:</h6><ul class="list-group mb-3">${loadsHTML}</ul><h6 class="d-flex justify-content-between"><span>Assign Truckers:</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.accordion-body').find('.trucker-assign-check').prop('checked', this.checked);"><label>Select All</label></div></h6><div class="border rounded p-3 row">${truckersHTML}</div><div class="mt-3"><button class="btn btn-success" onclick="handleBulkApproval('${req.requisition_id}')">Process Selected Loads</button></div></div></div></div>`);
                });
                container.html(accordion);
            } catch(error) { /* Handled */ }
        }

        async function handleBulkApproval(reqId) {
            const c = $(`#collapse-${reqId}`), loads = c.find('.load-check-box:checked').map((i, el)=>$(el).val()).get(), truckers = c.find('.trucker-assign-check:checked').map((i, el)=>$(el).val()).get();
            if(loads.length===0) return showToast('Select at least one load.', 'error'); if(truckers.length===0) return showToast('Assign at least one trucker.', 'error');
            try { await apiCall('/loads/approve', 'POST', { approvedLoadIds: loads, truckerAssignments: truckers, requisitionId: reqId }); showToast('Loads processed!', 'success'); load_admin_pending_loads_view(); } catch(e){}
        }

        async function load_admin_awarded_contracts_view() {
            const tbody = $('#admin-awarded-tbody'), empty = $('#admin-awarded-empty-state');
            try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/admin/awarded-contracts'); if (result.data.length === 0) return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy'); tbody.html(result.data.map(c => `<tr><td>${c.load_id}</td><td><small>${c.loading_point_address} <i class="fas fa-arrow-right"></i> ${c.unloading_point_address}</small></td><td>${c.trucker_name}</td><td><strong>${formatCurrency(c.awarded_amount)}</strong></td><td>${formatDate(c.awarded_date)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch(e){}
        }
        
        // --- USER MGMT ---
        async function load_admin_user_approvals_view() {
            const tbody = $('#admin-pending-users-tbody'), empty = $('#admin-pending-users-empty-state');
            try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/users/pending'); if(result.data.length === 0) return renderEmptyState(empty, 'No users are pending approval.', 'fa-user-check'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.company_name||'-'}</td><td>${u.contact_number||'-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-success" onclick="approveUser(${u.temp_id})">Approve</button> <button class="btn btn-danger" onclick="rejectUser(${u.temp_id})">Reject</button></div></td></tr>`).join('')); } catch(e){}
        }
        async function approveUser(id) { if (confirm('Approve user?')) { try { await apiCall('/users/approve', 'POST', {temp_id:id}); showToast('User Approved!', 'success'); load_admin_user_approvals_view(); } catch(e){} } }
        async function rejectUser(id) { if (confirm('Reject user?')) { try { await apiCall(`/pending-users/${id}`, 'DELETE'); showToast('User Rejected.', 'success'); load_admin_user_approvals_view(); } catch(e){} } }
        async function load_admin_user_control_view() {
            const tbody = $('#admin-users-tbody'), empty = $('#admin-users-empty-state');
            try { renderEmptyState(empty, 'Loading users...', 'fa-spinner fa-spin'); const result = await apiCall('/users'); if(result.data.length === 0) return renderEmptyState(empty, 'No users found.', 'fa-users'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td><span class="badge bg-${getBadgeColor(u.role)}">${u.role}</span></td><td>${u.company_name||'-'}</td><td>${u.contact_number||'-'}</td><td>${u.gstin||'-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-primary" onclick='openEditUserModal(${JSON.stringify(u)})'>Edit</button><button class="btn btn-danger" onclick="handleDeleteUser(${u.user_id})">Delete</button></div></td></tr>`).join('')); } catch (e) {}
        }
        function openAddUserModal() { $('#addUserModal').html(`<div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Add User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="add-user-form"><div class="mb-3"><label class="form-label">Role</label><select id="add-role" class="form-select" required><option value="">Select...</option><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><input type="text" id="add-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="add-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="add-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="add-contact" class="form-control" placeholder="Contact"></div><div class="mb-2"><input type="text" id="add-company" class="form-control" placeholder="Company Name"></div><div class="mb-3"><input type="text" id="add-gstin" class="form-control" placeholder="GSTIN"></div><button type="submit" class="btn btn-success w-100 fw-bold">Create User</button></form></div></div></div>`); addUserModal.show(); }
        async function handleAddUserSubmit(e) { e.preventDefault(); const data={full_name:$('#add-fullname').val(),email:$('#add-email').val(),password:$('#add-password').val(),role:$('#add-role').val(),company_name:$('#add-company').val(),contact_number:$('#add-contact').val(),gstin:$('#add-gstin').val()}; try { await apiCall('/users', 'POST', data); showToast('User created!', 'success'); addUserModal.hide(); load_admin_user_control_view(); } catch(e){} }
        function openEditUserModal(u) { $('#editUserModal').html(`<div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="edit-userid" value="${u.user_id}"><div class="mb-2"><label>Name</label><input type="text" id="edit-fullname" class="form-control" value="${u.full_name}" required></div><div class="mb-2"><label>Email</label><input type="email" id="edit-email" class="form-control" value="${u.email}" required></div><div class="mb-2"><label>Role</label><select id="edit-role" class="form-select" required><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><label>Company</label><input type="text" id="edit-company" class="form-control" value="${u.company_name||''}"></div><div class="mb-2"><label>Contact</label><input type="text" id="edit-contact" class="form-control" value="${u.contact_number||''}"></div><div class="mb-2"><label>GSTIN</label><input type="text" id="edit-gstin" class="form-control" value="${u.gstin||''}"></div><div class="mb-2"><label>New Password</label><input type="password" id="edit-password" class="form-control" placeholder="Leave blank to keep unchanged"></div><button type="submit" class="btn btn-success w-100">Save Changes</button></form></div></div></div>`); $('#edit-role').val(u.role); editUserModal.show(); }
        async function handleUserUpdateSubmit(e) { e.preventDefault(); const id=$('#edit-userid').val(), data={full_name:$('#edit-fullname').val(),email:$('#edit-email').val(),role:$('#edit-role').val(),company_name:$('#edit-company').val(),contact_number:$('#edit-contact').val(),gstin:$('#edit-gstin').val(),password:$('#edit-password').val()}; try { await apiCall(`/users/${id}`, 'PUT', data); showToast('User updated!', 'success'); editUserModal.hide(); load_admin_user_control_view(); } catch(e){} }
        async function handleDeleteUser(id) { if (confirm('Delete user?')) { try { await apiCall(`/users/${id}`, 'DELETE'); showToast('User deleted.', 'success'); load_admin_user_control_view(); } catch(e){} } }

        // --- REPORTS & BULK UPLOAD ---
        function openBulkUploadModal() { bulkUploadModal.show(); }
        async function handleBulkUpload(e) { e.preventDefault(); const file = $('#bulk-upload-file')[0].files[0]; if (!file) return showToast('Please select a file.', 'error'); const formData = new FormData(); formData.append('bulkFile', file); try { await apiCall('/loads/bulk-upload', 'POST', formData, true); showToast('File uploaded and is being processed.', 'success'); bulkUploadModal.hide(); } catch(e){} }
        function downloadBulkTemplate() { const data = [{"LoadingPoint":"City A", "UnloadingPoint":"City B", "MaterialName":"STEEL ITEMS", "TruckName":"10 Wheeler Truck", "WeightInTonnes":15, "RequirementDate":"2025-10-25"}]; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Loads"); XLSX.writeFile(wb, "Bulk_Load_Template.xlsx"); }
        async function load_admin_reports_view() {
            const kpiContainer = $('#report-kpis');
            const tableBody = $('#detailed-report-table tbody');
            try {
                kpiContainer.html(renderEmptyState(null, 'Loading report data...', 'fa-spinner fa-spin'));
                tableBody.empty();
                const result = await apiCall('/admin/reports-data', 'POST', { startDate: $('#report-start-date').val(), endDate: $('#report-end-date').val() });
                const { kpis, detailedReport } = result.data;
                kpiContainer.html(`<div class="col-md-6"><div class="card card-body"><h6>Total Spend</h6><h3 class="fw-bold">${formatCurrency(kpis.totalSpend)}</h3></div></div><div class="col-md-6"><div class="card card-body"><h6>Total Loads Awarded</h6><h3 class="fw-bold">${kpis.awardedLoads}</h3></div></div>`);
                if(detailedReport.length === 0) { tableBody.html(`<tr><td colspan="6" class="text-center text-muted">No awarded contracts found for the selected period.</td></tr>`); } 
                else { tableBody.html(detailedReport.map(r => `<tr><td>${r.load_id}</td><td><small>${r.loading_point_address} <i class="fas fa-arrow-right"></i> ${r.unloading_point_address}</small></td><td>${r.item_name}</td><td>${r.trucker_name}</td><td>${formatCurrency(r.awarded_amount)}</td><td>${formatDate(r.awarded_date)}</td></tr>`).join('')); }
            } catch(e){}
        }
        function downloadReport() {
            const table = document.getElementById("detailed-report-table");
            if(!table || $(table).find('tbody tr').length === 0) return showToast('No data available to download.', 'warning');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Report"});
            XLSX.writeFile(wb, "Awarded_Loads_Report.xlsx");
            showToast('Report downloaded.', 'success');
        }

        // =========================================================
        // ================ UTILITY FUNCTIONS ======================
        // =========================================================
        function showToast(m, t='info') { const c = $('#toast-container'), e = $(`<div><i class="fas ${t === 'success' ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i><span>${m}</span></div>`).addClass(`toast-notification ${t}`); c.append(e); setTimeout(()=>e.remove(), 4000); }
        function showLoader() { $('#loader-overlay').removeClass('hidden'); }
        function hideLoader() { $('#loader-overlay').addClass('hidden'); }
        function renderEmptyState(container, message, iconClass = 'fa-folder-open') { const html = `<div class="empty-state w-100"><i class="fas ${iconClass}"></i><p>${message}</p></div>`; if(container) $(container).html(html); return html;}
        function formatCurrency(v) { const n = parseFloat(v); return isNaN(n) ? '₹0' : `₹${n.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`; }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric'}) : 'N/A'; }
        function getBadgeColor(s) { return {'Awarded':'primary','Active':'success','Pending Approval':'warning','Submitted':'info','Rejected':'danger', 'Processed': 'secondary', 'Admin': 'info', 'Super Admin': 'danger', 'Trucker': 'success', 'Shipper': 'secondary'}[s]||'dark'; }
    </script>
</body>
</html>
