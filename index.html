<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEB'S LOGISTICS</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/truck.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <style>
        :root {
            --primary-color: #5E72E4; --secondary-color: #F4F5F7; --success-color: #2DCE89;
            --info-color: #11CDEF; --warning-color: #FB6340; --danger-color: #F5365C;
            --sidebar-bg: #172B4D; --sidebar-text: #8898AA; --sidebar-hover-bg: #1F3866;
            --sidebar-active-text: #ffffff; --content-bg: #F8F9FE; --card-bg: #ffffff;
            --text-dark: #32325D; --text-muted: #8898AA; --border-color: #E9ECEF;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--content-bg); }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 10002; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10003; }
        .toast-notification { padding: 15px 20px; color: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .toast-notification.success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .toast-notification.error { background: linear-gradient(87deg, #f5365c 0, #f56036 100%) !important; }
        .toast-notification.info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #172B4D; }
        #login-video-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; filter: brightness(0.4); }
        #login-container { width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); color: white; }
        #login-container .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; }
        #login-container .form-control::placeholder { color: rgba(255,255,255,0.7); }
        #login-container a { color: var(--info-color); }
        .password-container { position: relative; }
        .password-container .toggle-password { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); cursor: pointer; color: rgba(255,255,255,0.7); }
        .wrapper { display: flex; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transition: all 0.3s ease-in-out; box-shadow: 0 0 2rem 0 rgba(136,152,170,.15); }
        .sidebar .logo { font-size: 1.2rem; font-weight: 600; text-align: center; color: white; padding: 22px 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar .logo i { color: var(--info-color); }
        .sidebar .nav-link { color: var(--sidebar-text); padding: 12px 25px; border-radius: .375rem; margin: 0 1rem 5px; transition: all 0.2s ease; white-space: nowrap; cursor: pointer; display: flex; align-items: center; justify-content: space-between;}
        .sidebar .nav-link:hover { background-color: var(--sidebar-hover-bg); color: var(--sidebar-active-text); }
        .sidebar .nav-link.active { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; color: var(--sidebar-active-text); font-weight: 500; box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08); }
        .sidebar .nav-link .nav-link-text { display: flex; align-items: center; }
        .sidebar .nav-link .nav-link-text i { margin-right: 15px; width: 20px; text-align: center; font-size: .95rem; }
        .sidebar .user-profile { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 10px; text-align: center; }
        .main-content { width: 100%; padding: 30px; margin-left: 260px; transition: margin-left 0.3s ease-in-out; }
        .top-header { display: flex; justify-content: space-between; align-items: center; background: transparent; padding: 0; margin-bottom: 30px; }
        .sidebar-toggle-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-dark); }
        .stat-card { border: none; border-radius: .5rem; color: white; padding: 25px; box-shadow: 0 15px 35px rgba(50,50,93,.1), 0 5px 15px rgba(0,0,0,.07) !important; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card .display-4 { font-weight: 600; }
        .stat-card i.stat-icon { font-size: 3.5rem; opacity: 0.3; transform: rotate(-15deg); }
        .bg-gradient-primary { background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important; }
        .bg-gradient-success { background: linear-gradient(87deg, #2dce89 0, #2dcecc 100%) !important; }
        .bg-gradient-warning { background: linear-gradient(87deg, #fb6340 0, #fbb140 100%) !important; }
        .bg-gradient-info { background: linear-gradient(87deg, #11cdef 0, #1171ef 100%) !important; }
        .card { border: none; border-radius: .5rem; box-shadow: 0 1px 3px rgba(50,50,93,.15), 0 1px 0 rgba(0,0,0,.02); }
        .card-header { background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); font-weight: 600; padding: 1.25rem 1.5rem; }
        .card-body { padding: 1.5rem; }
        .table-hover>tbody>tr:hover>* { background-color: #f6f9fc; }
        .bidding-card { border: 1px solid var(--border-color); border-radius: .5rem; overflow: hidden; background-color: #fff; }
        .bidding-card .card-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .bidding-card .bid-input-area { background-color: #f8f9fe; border-top: 1px solid var(--border-color); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 2.5rem; margin-bottom: 1rem; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .message-bubble { padding: 8px 14px; border-radius: 18px; margin-bottom: 10px; max-width: 75%; display: inline-block; word-wrap: break-word; position: relative; }
        .message-bubble.sent { background-color: #dcf8c6; float: right; clear: both; border-bottom-right-radius: 4px; }
        .message-bubble.received { background-color: #f1f0f0; float: left; clear: both; border-bottom-left-radius: 4px; }
        .message-bubble.sent::after { content: ''; position: absolute; bottom: 0; height: 20px; width: 20px; background-color: #dcf8c6; right: -10px; border-bottom-left-radius: 16px; clip-path: path("M 20 0 A 20 20 0 0 1 0 20 L 20 20 L 20 0 Z"); }
        .message-bubble.received::after { content: ''; position: absolute; bottom: 0; height: 20px; width: 20px; background-color: #f1f0f0; left: -10px; border-bottom-right-radius: 16px; clip-path: path("M 0 0 A 20 20 0 0 0 20 20 L 0 20 L 0 0 Z"); }
        .timestamp { font-size: 0.75rem; color: #999; margin-top: 5px; text-align: right; }
        #chat-messages { display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner-border text-primary" role="status"></div></div>
    <div id="toast-container"></div>

    <div id="login-wrapper">
        <video autoplay muted loop id="login-video-bg"> <source src="https://assets.mixkit.co/videos/preview/mixkit-highway-in-the-middle-of-a-mountain-range-4633-large.mp4" type="video/mp4"> </video>
        <div id="login-container" class="p-4 p-md-5">
            <h2 class="text-center mb-1 fw-bold"><i class="fas fa-truck text-info"></i> DEB'S LOGISTICS</h2>
            <p class="text-center mb-4">Login to your account</p>
            <form id="login-form">
                <div class="mb-3"><input type="email" id="email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3 password-container">
                    <input type="password" id="password" class="form-control" placeholder="Password" required>
                    <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                </div>
                <button type="submit" class="btn btn-primary w-100 fw-bold">Log In</button>
            </form>
            <p class="text-center mt-3 small">Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Register Now</a></p>
        </div>
    </div>

    <div id="app-container" class="wrapper hidden"></div>

    <div class="modal fade" id="registerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Create Account</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="register-form"><div class="mb-3"><select id="reg-role" class="form-select" required><option value="">Register as...</option><option value="Shipper">Shipper (I have loads)</option><option value="Trucker">Trucker (I have trucks)</option></select></div><div class="mb-2"><input type="text" id="reg-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="reg-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="reg-contact" class="form-control" placeholder="Contact Number" required></div><div class="mb-2 hidden" id="reg-company-wrapper"><input type="text" id="reg-company" class="form-control" placeholder="Company Name"></div><div class="mb-3 hidden" id="reg-gstin-wrapper"><input type="text" id="reg-gstin" class="form-control" placeholder="GSTIN (Optional)"></div><button type="submit" class="btn btn-success w-100 fw-bold">Register</button></form></div></div></div></div>
    <div class="modal fade" id="bulkUploadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="bulk-upload-modal-title">Bulk Upload</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Please upload an Excel file. <a href="#" id="download-template-link">Download Template</a></p><hr><form id="bulk-upload-form"><input type="hidden" id="bulk-upload-type"><div class="mb-3"><label class="form-label">Select Excel File</label><input class="form-control" type="file" id="bulk-upload-file" accept=".xlsx, .xls" required></div><button type="submit" class="btn btn-success w-100">Upload and Submit</button></form></div></div></div></div>
    <div class="modal fade" id="addUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Add New User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="add-user-form"><div class="mb-3"><label class="form-label">Role</label><select id="add-role" class="form-select" required><option value="">Select...</option><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><input type="text" id="add-fullname" class="form-control" placeholder="Full Name" required></div><div class="mb-2"><input type="email" id="add-email" class="form-control" placeholder="Email" required></div><div class="mb-2"><input type="password" id="add-password" class="form-control" placeholder="Password" required></div><div class="mb-2"><input type="text" id="add-contact" class="form-control" placeholder="Contact"></div><div class="mb-2"><input type="text" id="add-company" class="form-control" placeholder="Company Name"></div><div class="mb-3"><input type="text" id="add-gstin" class="form-control" placeholder="GSTIN"></div><button type="submit" class="btn btn-success w-100 fw-bold">Create User</button></form></div></div></div></div>
    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="edit-user-form"><input type="hidden" id="edit-userid"><div class="mb-2"><label>Name</label><input type="text" id="edit-fullname" class="form-control" required></div><div class="mb-2"><label>Email</label><input type="email" id="edit-email" class="form-control" required></div><div class="mb-2"><label>Role</label><select id="edit-role" class="form-select" required><option value="Shipper">Shipper</option><option value="Trucker">Trucker</option><option value="Admin">Admin</option></select></div><div class="mb-2"><label>Company</label><input type="text" id="edit-company" class="form-control"></div><div class="mb-2"><label>Contact</label><input type="text" id="edit-contact" class="form-control"></div><div class="mb-2"><label>GSTIN</label><input type="text" id="edit-gstin" class="form-control"></div><div class="mb-2"><label>New Password</label><input type="password" id="edit-password" class="form-control" placeholder="Leave blank to keep unchanged"></div><button type="submit" class="btn btn-success w-100">Save Changes</button></form></div></div></div></div>
    <div class="modal fade" id="masterDataModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="master-data-modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="master-data-form" data-type="" data-id=""><div class="mb-3"><label>Name</label><input type="text" id="master-name" class="form-control" required></div><div id="master-active-switch" class="form-check form-switch"><input class="form-check-input" type="checkbox" id="master-active"><label class="form-check-label" for="master-active">Is Active</label></div><button type="submit" class="btn btn-success w-100 mt-3">Save</button></form></div></div></div></div>
    <div class="modal fade" id="viewBidsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="viewBidsModalTitle">Bids for Load</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewBidsModalBody"></div></div></div></div>
    <div class="modal fade" id="assignTruckersModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="assignTruckersModalTitle">Assign Truckers</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="assign-trucker-req-id"><div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.assign-trucker-checkbox').prop('checked', this.checked)"><label class="form-check-label">Select All Truckers</label></div><hr><div id="assign-trucker-checklist" class="border rounded p-3" style="max-height: 250px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="handleUpdateTruckerAssignments()">Save Changes</button></div></div></div></div>
    <div class="modal fade" id="advancedBulkAwardModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Advanced Bulk Award</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="text-muted">Select one winning bid for each load you wish to award.</p><div class="accordion" id="advanced-bulk-award-modal-body"></div></div><div class="modal-footer"><div class="w-100"><div class="mb-2"><label class="form-label">Remarks (Mandatory)</label><textarea id="advanced-bulk-award-remarks" class="form-control" rows="2" placeholder="e.g., Awarded based on best price."></textarea></div><div class="d-flex justify-content-end"><button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-success" onclick="handleSubmitAdvancedBulkAward()">Submit Awards</button></div></div></div></div></div></div>
    <div class="modal fade" id="reopenBiddingModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Re-open Bidding</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="reopen-load-ids"><div class="mb-3"><label class="form-label"><strong>Remarks (Mandatory)</strong></label><textarea id="reopen-remarks" class="form-control" rows="2"></textarea></div><div class="mb-3"><label class="form-label d-flex justify-content-between"><span>Select Truckers for New Bidding Round</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.modal-body').find('.reopen-trucker-checkbox').prop('checked', this.checked)"><label class="form-check-label small">Select All</label></div></label><div id="reopen-trucker-checklist" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-warning" onclick="submitReopenBidding()">Confirm & Re-open</button></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const API_BASE_URL = '/api';
        let loginWrapper, appContainer;
        let registerModal, editUserModal, addUserModal, bulkUploadModal, masterDataModal, viewBidsModal, assignTruckersModal, advancedBulkAwardModal, reopenBiddingModal;
        let charts = {};
        let truckerLoadsCache = [];
        let currentTruckerViewMode = 'table';
        let chatPollingInterval = null;

        const views = {
            'shipper-create-load-view': `<div class="card view"><div class="card-header"><h5 class="mb-0"><i class="fas fa-truck-loading me-2"></i>Post Load Requirements</h5></div><div class="card-body"><form id="load-request-form"><div id="load-items-container"></div><div class="d-flex justify-content-between mt-3"><button type="button" class="btn btn-outline-secondary" onclick="addLoadItem()"><i class="fas fa-plus me-2"></i>Add Another Load</button><button type="submit" class="btn btn-primary fw-bold">Submit All Load Requests</button></div></form></div></div>`,
            'shipper-status-view': `<div class="card view"><div class="card-header"><h5 class="mb-0"><i class="fas fa-history me-2"></i>My Load Request Status</h5></div><div class="card-body" id="shipper-req-status-list"></div></div>`,
            'trucker-dashboard-view': `<div class="row g-4 mb-4 view"><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Open for Bidding</h5><p class="display-4" id="trucker-stats-open">--</p></div><i class="fas fa-file-signature stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary" onclick="navigateTo('trucker-bidding-history-view')"><div><h5 class="mb-0">Bids Submitted</h5><p class="display-4" id="trucker-stats-submitted">--</p></div><i class="fas fa-gavel stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('trucker-awarded-contracts-view')"><div><h5 class="mb-0">Contracts Won</h5><p class="display-4" id="trucker-stats-won">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('trucker-open-loads-view')"><div><h5 class="mb-0">Needs My Bid</h5><p class="display-4" id="trucker-stats-needs-bid">--</p></div><i class="fas fa-edit stat-icon"></i></div></div></div><div class="row g-4 view"><div class="col-lg-5"><div class="card h-100"><div class="card-header"><h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Performance Snapshot</h5></div><div class="card-body p-2"><ul class="list-group list-group-flush" id="trucker-kpi-container"></ul></div></div></div><div class="col-lg-7"><div class="card h-100"><div class="card-header d-flex justify-content-between"><span><i class="fas fa-history me-2"></i>My Recent Bids</span><button class="btn btn-sm btn-outline-primary" onclick="navigateTo('trucker-bidding-history-view')">View All</button></div><div class="card-body p-0"><div class="list-group list-group-flush" id="trucker-recent-bids"></div></div></div></div></div>`,
            'trucker-open-loads-view': `<div class="view"><div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"><h5>Open Loads for Bidding</h5><div class="btn-group"><button class="btn btn-sm btn-outline-primary" id="view-mode-cards" onclick="toggleTruckerLoadsView('cards')"><i class="fas fa-th-large"></i></button><button class="btn btn-sm btn-outline-primary active" id="view-mode-table" onclick="toggleTruckerLoadsView('table')"><i class="fas fa-bars"></i></button><button class="btn btn-success ms-2" onclick="handleBulkBidSubmit()"><i class="fas fa-check-double me-2"></i>Submit Bids</button></div></div><div id="trucker-bidding-container" class="d-grid gap-4 hidden"></div><div id="trucker-bidding-table-container" class="card"></div></div>`,
            'trucker-bidding-history-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">My Bidding History</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>Route</th><th>My Bid</th><th>My Rank</th><th>L1 Bid</th><th>Status</th><th>Date</th></tr></thead><tbody id="trucker-bids-tbody"></tbody></table><div id="trucker-bids-empty-state"></div></div></div>`,
            'trucker-awarded-contracts-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">My Awarded Contracts</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>Route</th><th>Awarded Amount</th><th>Date</th></tr></thead><tbody id="trucker-awarded-tbody"></tbody></table><div id="trucker-awarded-empty-state"></div></div></div>`,
            'admin-dashboard-view': `<div class="row g-4 mb-4 view"><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-primary" onclick="navigateTo('admin-all-loads-view')"><div><h5 class="mb-0">Active Loads</h5><p class="display-4" id="stats-active-loads">--</p></div><i class="fas fa-truck stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-success" onclick="navigateTo('admin-user-approvals-view')"><div><h5 class="mb-0">Pending Users</h5><p class="display-4" id="stats-pending-users">--</p></div><i class="fas fa-user-check stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-warning" onclick="navigateTo('admin-pending-loads-view')"><div><h5 class="mb-0">Pending Loads</h5><p class="display-4" id="stats-pending-loads">--</p></div><i class="fas fa-inbox stat-icon"></i></div></div><div class="col-lg-3 col-md-6"><div class="stat-card bg-gradient-info" onclick="navigateTo('admin-awarded-contracts-view')"><div><h5 class="mb-0">Loads Awarded</h5><p class="display-4" id="stats-awarded-contracts">--</p></div><i class="fas fa-trophy stat-icon"></i></div></div></div><div class="text-end mb-3"><button class="btn btn-primary" onclick="openBulkUploadModal('load')"><i class="fas fa-upload me-2"></i>Bulk Upload Loads</button></div><div class="row g-4"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Analytics Overview</h5></div><div class="card-body"><div class="row"><div class="col-lg-7 mb-4 mb-lg-0"><h6 class="text-muted text-center">Load Creation Trends</h6><div class="chart-container"><canvas id="adminLoadChart"></canvas></div></div><div class="col-lg-5"><h6 class="text-muted text-center">Top Trucker Bidding</h6><div class="chart-container"><canvas id="adminTruckerBiddingChart"></canvas></div></div></div></div></div></div></div>`,
            'admin-pending-loads-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">Pending Load Approvals</h5></div><div class="card-body"><div id="pending-loads-accordion-container"></div></div></div>`,
            'admin-all-loads-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>All Active & Awarded Loads</h5><div><button class="btn btn-sm btn-success" onclick="openAdvancedBulkAwardModal()"><i class="fas fa-trophy me-2"></i>Award Selected</button><button class="btn btn-sm btn-info ms-2" onclick="downloadTableData('admin-loads-table', 'All_Loads_Report.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle" id="admin-loads-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="$(this).closest('table').find('.load-checkbox').prop('checked', this.checked)"></th><th>TRN</th><th>Load ID</th><th>Route</th><th>Assigned Truckers</th><th>Status</th><th>L1 Trucker</th><th>L1 Bid</th><th>Actions</th></tr></thead><tbody id="admin-loads-tbody"></tbody></table><div id="admin-loads-empty-state"></div></div></div>`,
            'admin-bidding-history-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>Platform Bidding History</h5><button class="btn btn-sm btn-success" onclick="downloadTableData('admin-bids-table', 'Bidding_History.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle" id="admin-bids-table"><thead class="table-light"><tr><th>Load ID</th><th>Route</th><th>Trucker</th><th>Bid Amount</th><th>Date</th></tr></thead><tbody id="admin-bids-tbody"></tbody></table><div id="admin-bids-empty-state"></div></div></div>`,
            'admin-awarded-contracts-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>All Awarded Contracts</h5><div><button class="btn btn-sm btn-danger" onclick="openReopenBiddingModal()"><i class="fas fa-history me-2"></i>Re-open Selected</button><button class="btn btn-sm btn-success ms-2" onclick="downloadTableData('admin-awarded-table', 'Awarded_Contracts_Report.xlsx')"><i class="fas fa-download me-2"></i>Download</button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle" id="admin-awarded-table"><thead class="table-light"><tr><th><input type="checkbox" onchange="$(this).closest('table').find('.awarded-load-checkbox').prop('checked', this.checked)"></th><th>Load ID</th><th>TRN</th><th>Route</th><th>Trucker</th><th>Contact</th><th>Awarded Amount</th><th>Date</th></tr></thead><tbody id="admin-awarded-tbody"></tbody></table><div id="admin-awarded-empty-state"></div></div></div>`,
            'admin-reports-view': `<div class="card view"><div class="card-header d-flex justify-content-between"><h5>Reports & Analytics</h5><button class="btn btn-sm btn-success" onclick="downloadReport()"><i class="fas fa-download me-2"></i>Download Detailed Report</button></div><div class="card-body"><div class="row g-3 align-items-center border p-3 rounded mb-4"><div class="col-md-5"><label class="form-label-sm">Start Date</label><input type="date" id="report-start-date" class="form-control form-control-sm"></div><div class="col-md-5"><label class="form-label-sm">End Date</label><input type="date" id="report-end-date" class="form-control form-control-sm"></div><div class="col-md-2 d-grid"><button id="report-apply-filter" class="btn btn-primary btn-sm mt-md-3">Apply</button></div></div><div class="row g-4" id="report-kpis"></div><div class="mt-4"><h5 class="text-center text-muted">Detailed Report</h5><div class="table-responsive"><table class="table table-sm table-striped" id="detailed-report-table"><thead><tr><th>Load ID</th><th>Route</th><th>Material</th><th>Trucker</th><th>Awarded Amount</th><th>Award Date</th></tr></thead><tbody></tbody></table></div></div></div></div>`,
            'admin-master-data-view': `<div class="row view"><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>Material Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('item')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('item')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="item-master-tbody"></tbody></table></div></div></div><div class="col-md-6"><div class="card"><div class="card-header d-flex justify-content-between"><span>Truck Types</span><div><button class="btn btn-info btn-sm me-2" onclick="openBulkUploadModal('truck')"><i class="fas fa-upload"></i></button><button class="btn btn-success btn-sm" onclick="openMasterDataModal('truck')"><i class="fas fa-plus"></i></button></div></div><div class="card-body table-responsive p-0"><table class="table table-hover"><tbody id="truck-master-tbody"></tbody></table></div></div></div></div>`,
            'admin-user-approvals-view': `<div class="card view"><div class="card-header"><h5 class="mb-0">Pending User Approvals</h5></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>Action</th></tr></thead><tbody id="admin-pending-users-tbody"></tbody></table><div id="admin-pending-users-empty-state"></div></div></div>`,
            'admin-user-control-view': `<div class="card view"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">User Control Center</h5><button class="btn btn-success btn-sm" onclick="openAddUserModal()"><i class="fas fa-plus me-2"></i>Add User</button></div><div class="card-body table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Name</th><th>Email</th><th>Role</th><th>Company</th><th>Contact</th><th>GSTIN</th><th>Action</th></tr></thead><tbody id="admin-users-tbody"></tbody></table><div id="admin-users-empty-state"></div></div></div>`,
            'messaging-view': `<div class="card view" style="height: calc(100vh - 125px);"><div class="row g-0 h-100"><div class="col-lg-4 col-12 border-end d-flex flex-column"><div class="card-header"><h5 class="mb-0">Conversations</h5></div><div id="chat-list" class="list-group list-group-flush" style="overflow-y: auto; flex-grow: 1;"></div></div><div class="col-lg-8 col-12 d-flex flex-column"><div id="chat-main" class="h-100"><div id="chat-welcome" class="d-flex align-items-center justify-content-center h-100"><div class="text-center text-muted"><i class="fas fa-comments fa-3x mb-3"></i><p>Select a conversation to start messaging.</p></div></div><div id="chat-window" class="d-none h-100 d-flex flex-column"><div class="card-header d-flex align-items-center border-bottom"><h5 id="chat-with-name" class="mb-0"></h5></div><div id="chat-messages" class="card-body p-4" style="overflow-y: auto; flex-grow: 1;"></div><div class="card-footer bg-light p-3 border-top"><form id="message-form" class="d-flex"><input type="text" id="message-input" class="form-control" placeholder="Type a message..." autocomplete="off" required><button type="submit" class="btn btn-primary ms-2"><i class="fas fa-paper-plane"></i></button></form></div></div></div></div></div></div>`
        };
        
        $(document).ready(() => {
            loginWrapper = $('#login-wrapper');
            appContainer = $('#app-container');
            try {
                registerModal = new bootstrap.Modal('#registerModal');
                bulkUploadModal = new bootstrap.Modal('#bulkUploadModal');
                addUserModal = new bootstrap.Modal('#addUserModal');
                editUserModal = new bootstrap.Modal('#editUserModal');
                masterDataModal = new bootstrap.Modal('#masterDataModal');
                viewBidsModal = new bootstrap.Modal('#viewBidsModal');
                assignTruckersModal = new bootstrap.Modal('#assignTruckersModal');
                advancedBulkAwardModal = new bootstrap.Modal('#advancedBulkAwardModal');
                reopenBiddingModal = new bootstrap.Modal('#reopenBiddingModal');
            } catch (e) { console.error("Error initializing modals:", e); }
            const user = sessionStorage.getItem('loggedInUser');
            if (user && sessionStorage.getItem('authToken')) {
                setupUIForRole(JSON.parse(user));
            } else {
                loginWrapper.removeClass('hidden');
                appContainer.addClass('hidden');
            }
            $('#login-form').on('submit', handleLogin);
            $('#register-form').on('submit', handleRegistration);
            $('#reg-role').on('change', handleRoleChange);
            $('#togglePassword').on('click', function() {
                const p = $('#password');
                p.attr('type', p.attr('type') === 'password' ? 'text' : 'password');
                $(this).toggleClass('fa-eye-slash fa-eye');
            });
            $(document).on('submit', '#load-request-form', handleLoadSubmit);
            $(document).on('submit', '#add-user-form', handleAddUserSubmit);
            $(document).on('submit', '#edit-user-form', handleUserUpdateSubmit);
            $(document).on('submit', '#bulk-upload-form', handleBulkUpload);
            $(document).on('click', '#report-apply-filter', load_admin_reports_view);
            $(document).on('submit', '#master-data-form', handleMasterDataSubmit);
        });

        async function apiCall(endpoint, method = 'GET', body = null, isFormData = false, showLoaderFlag = true) {
            if(showLoaderFlag) showLoader();
            try {
                const headers = {};
                const token = sessionStorage.getItem('authToken');
                if (token) headers['Authorization'] = `Bearer ${token}`;
                if (!isFormData) headers['Content-Type'] = 'application/json';
                const options = { method, headers };
                if (body) options.body = isFormData ? body : JSON.stringify(body);
                const response = await fetch(API_BASE_URL + endpoint, options);
                if (response.status === 204) return { success: true };
                const resultText = await response.text();
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (e) {
                    throw new Error("Received an invalid response from the server. Please check the API.");
                }

                if (!response.ok) {
                    if (response.status === 401 && !endpoint.includes('/login')) {
                        showToast('Session expired. Logging out.', 'error');
                        setTimeout(handleLogout, 2000);
                    }
                    throw new Error(result.message || 'Server error');
                }
                return result;
            } catch (error) {
                showToast(error.message, 'error');
                throw error;
            } finally {
                if(showLoaderFlag) hideLoader();
            }
        }

        function navigateTo(viewId) {
            if (!views[viewId]) return console.error("View not found:", viewId);
            if (chatPollingInterval) clearInterval(chatPollingInterval);
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            $('#main-view').html(views[viewId]);
            $('#nav-links .nav-link').removeClass('active');
            const navLink = $(`[data-view="${viewId}"]`);
            if (navLink.length) {
                navLink.addClass('active');
                $('#header-title').text(navLink.find('span').text().trim());
            }
            const loadFunctionName = `load_${viewId.replace(/-/g, '_')}`;
            if (typeof window[loadFunctionName] === 'function') {
                window[loadFunctionName]();
            }
        }
        async function handleLogin(e) { e.preventDefault(); try { const result = await apiCall('/login', 'POST', { email: $('#email').val(), password: $('#password').val() }); sessionStorage.setItem('loggedInUser', JSON.stringify(result.user)); sessionStorage.setItem('authToken', result.token); await setupUIForRole(result.user); } catch (error) {} }

        function handleLogout() { if (chatPollingInterval) clearInterval(chatPollingInterval); sessionStorage.clear(); window.location.reload(); }

        function handleRoleChange() { const isTrucker = $('#reg-role').val() === 'Trucker'; $('#reg-company-wrapper, #reg-gstin-wrapper').toggleClass('hidden', !isTrucker); $('#reg-company').prop('required', isTrucker); }
        async function handleRegistration(e) { e.preventDefault(); const data = { FullName: $('#reg-fullname').val(), Email: $('#reg-email').val(), Password: $('#reg-password').val(), Role: $('#reg-role').val(), CompanyName: $('#reg-company').val(), ContactNumber: $('#reg-contact').val(), GSTIN: $('#reg-gstin').val() }; try { await apiCall('/register', 'POST', data); showToast('Registration successful! Awaiting admin approval.', 'success'); registerModal.hide(); $(e.target)[0].reset(); } catch (e) {} }

        function setupUIForRole(user) {
            loginWrapper.addClass('hidden');
            appContainer.removeClass('hidden');
            const roleNavs = {
                'Shipper': `<a class="nav-link" data-view="shipper-create-load-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-plus-circle"></i> <span>Post New Loads</span></div></a><a class="nav-link" data-view="shipper-status-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>My Load Status</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
                'Trucker': `<a class="nav-link" data-view="trucker-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a><a class="nav-link" data-view="trucker-open-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-truck-loading"></i> <span>Open Loads</span></div></a><a class="nav-link" data-view="trucker-bidding-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-gavel"></i> <span>Bidding History</span></div></a><a class="nav-link" data-view="trucker-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>My Contracts</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
                'Admin': `<a class="nav-link" data-view="admin-dashboard-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></div></a><a class="nav-link" data-view="admin-pending-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-inbox"></i> <span>Load Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-loads"></span></a><a class="nav-link" data-view="admin-all-loads-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-list-alt"></i> <span>All Loads</span></div></a><a class="nav-link" data-view="admin-bidding-history-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-history"></i> <span>Bidding History</span></div></a><a class="nav-link" data-view="admin-awarded-contracts-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-trophy"></i> <span>Awarded Contracts</span></div></a><a class="nav-link" data-view="admin-reports-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-chart-line"></i> <span>Reports</span></div></a><a class="nav-link" data-view="admin-master-data-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-database"></i> <span>Master Data</span></div></a><a class="nav-link" data-view="admin-user-approvals-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-user-check"></i> <span>User Approvals</span></div><span class="badge bg-warning rounded-pill" id="badge-pending-users"></span></a><a class="nav-link" data-view="admin-user-control-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-users-cog"></i> <span>User Control</span></div></a><a class="nav-link" data-view="messaging-view" onclick="navigateTo(this.dataset.view)"><div class="nav-link-text"><i class="fas fa-comments"></i> <span>Messages</span></div><span class="badge bg-danger rounded-pill" id="badge-unread-messages"></span></a>`,
            };
            roleNavs['Super Admin'] = roleNavs['Admin'];
            const appHTML = `<nav class="sidebar" id="sidebar"><div class="logo"><i class="fas fa-truck"></i> <span>DEB'S LOGISTICS</span></div><div id="nav-links" class="flex-grow-1">${roleNavs[user.role] || ''}</div><div class="user-profile"><div><h6 class="mb-0 text-white">${user.full_name}</h6><small class="text-muted">${user.email}</small></div><button onclick="handleLogout()" class="btn btn-sm btn-outline-danger w-100 mt-2"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button></div></nav><main class="main-content" id="main-content"><div class="top-header"><h1 id="header-title" class="h4 mb-0 fw-bold text-dark"></h1><button class="btn btn-sm btn-outline-primary" onclick="handleManualRefresh()"><i class="fas fa-sync-alt me-1"></i>Refresh</button></div><div id="main-view"></div></main>`;
            appContainer.html(appHTML);
            const defaultViewMap = { 'Shipper': 'shipper-create-load-view', 'Trucker': 'trucker-dashboard-view', 'Admin': 'admin-dashboard-view', 'Super Admin': 'admin-dashboard-view' };
            navigateTo(defaultViewMap[user.role]);
            setInterval(fetchSidebarCounts, 60000);
            fetchSidebarCounts();
        }
        async function handleManualRefresh() { const currentViewLink = $('#nav-links .nav-link.active'); if (currentViewLink.length > 0) { showToast('Refreshing data...', 'info'); navigateTo(currentViewLink.data('view')); } }
        async function load_shipper_create_load_view() { try { await Promise.all([apiCall('/master-data/truck-types', 'GET', null, false, false), apiCall('/master-data/items', 'GET', null, false, false)]); $('#load-items-container').html(''); addLoadItem(); } catch (e) { $('#load-request-form').html('<div class="alert alert-danger">Could not load required data. Please refresh.</div>'); } }
        async function addLoadItem() { const itemIndex = $('#load-items-container .card').length; const [trucks, items] = await Promise.all([apiCall('/master-data/truck-types', 'GET', null, false, false), apiCall('/master-data/items', 'GET', null, false, false)]); const truckOptions = trucks.data.filter(t => t.is_active).map(t => `<option value="${t.truck_type_id}">${t.truck_name}</option>`).join(''); const itemOptions = items.data.filter(i => i.is_active).map(i => `<option value="${i.item_id}">${i.item_name}</option>`).join(''); const today = new Date().toISOString().split('T')[0]; const itemHtml = `<div class="card card-body mb-3"><div class="d-flex justify-content-end">${itemIndex > 0 ? `<button type="button" class="btn-close" onclick="$(this).closest('.card').remove()"></button>` : ''}</div><div class="row"><div class="col-md-6 mb-3"><label class="form-label fw-bold">Loading Point</label><input type="text" class="form-control loading_point_address" required></div><div class="col-md-6 mb-3"><label class="form-label fw-bold">Unloading Point</label><input type="text" class="form-control unloading_point_address" required></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label fw-bold">Material</label><select class="form-select item_id" required><option value="">Select...</option>${itemOptions}</select></div><div class="col-md-6 mb-3"><label class="form-label fw-bold">Truck Type</label><select class="form-select truck_type_id" required><option value="">Select...</option>${truckOptions}</select></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label fw-bold">Weight (Tonnes)</label><input type="number" class="form-control approx_weight_tonnes" step="0.1" required></div><div class="col-md-6 mb-3"><label class="form-label fw-bold">Date</label><input type="date" class="form-control requirement_date" min="${today}" value="${today}" required></div></div></div>`; $('#load-items-container').append(itemHtml); $('#load-items-container .item_id, #load-items-container .truck_type_id').select2({ theme: 'bootstrap-5' }); }
        async function handleLoadSubmit(e) { e.preventDefault(); const loads = []; $('#load-items-container .card').each(function() { const card = $(this); loads.push({ loading_point_address: card.find('.loading_point_address').val(), unloading_point_address: card.find('.unloading_point_address').val(), item_id: card.find('.item_id').val(), truck_type_id: card.find('.truck_type_id').val(), approx_weight_tonnes: card.find('.approx_weight_tonnes').val(), requirement_date: card.find('.requirement_date').val() }); }); if (loads.length === 0) return showToast('Please add at least one load.', 'warning'); try { await apiCall('/loads', 'POST', { items: JSON.stringify(loads) }); showToast(`${loads.length} load request(s) submitted!`, 'success'); navigateTo('shipper-create-load-view'); } catch (e) {} }
        async function load_shipper_status_view() { const listDiv = $('#shipper-req-status-list'); try { renderEmptyState(listDiv, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/shipper/status'); if (result.data.length === 0) return renderEmptyState(listDiv, 'You have not posted any loads yet.', 'fa-file-signature'); listDiv.html(result.data.map(req => `<div class="card mb-3 view"><div class="card-header d-flex justify-content-between"><strong>TRN: REQ-${req.requisition_id}</strong><small>${formatDate(req.created_at)}</small></div><ul class="list-group list-group-flush">${req.loads.map(load => `<li class="list-group-item"><div class="d-flex w-100 justify-content-between"><div class="me-3"><h6 class="mb-0">${load.item_name} (Load ID: ${load.load_id})</h6><small>${load.loading_point_address} <i class="fas fa-long-arrow-alt-right"></i> ${load.unloading_point_address}</small></div><span class="badge bg-${getBadgeColor(load.status)} align-self-center">${load.status}</span></div>${load.status === 'Awarded' ? `<small class="d-block text-success mt-1"><i class="fas fa-trophy me-1"></i>Awarded to: ${load.awarded_vendor || 'N/A'} for <strong>${formatCurrency(load.awarded_amount)}</strong></small>` : ''}</li>`).join('')}</ul></div>`).join('')); } catch (e) {} }
        async function load_trucker_dashboard_view() { try { const result = await apiCall('/trucker/dashboard-stats'); const data = result.data; $('#trucker-stats-open').text(data.assignedLoads || '0'); $('#trucker-stats-submitted').text(data.submittedBids || '0'); $('#trucker-stats-won').text(data.contractsWon || '0'); $('#trucker-stats-needs-bid').text(data.needsBid || '0'); $('#trucker-kpi-container').html(data.kpis.map(kpi => `<li class="list-group-item d-flex justify-content-between align-items-center"><span><i class="fas ${kpi.icon} text-${kpi.color} me-3"></i>${kpi.title}</span><span class="fw-bold h5 mb-0">${kpi.value}</span></li>`).join('') || '<li class="list-group-item text-center text-muted">No data.</li>'); $('#trucker-recent-bids').html(data.recentBids.map(bid => `<a href="#" class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 small">Load #${bid.load_id}</h6><span class="badge bg-${getBadgeColor(bid.status)}">${bid.status || 'N/A'}</span></div><p class="mb-1 small text-muted">My Bid: ${formatCurrency(bid.bid_amount)}</p></a>`).join('') || '<div class="list-group-item text-center text-muted small">No recent bids.</div>'); } catch (e) {} }
        async function load_trucker_open_loads_view() { try { renderEmptyState($('#trucker-bidding-container'), 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/loads/assigned'); truckerLoadsCache = result.data; if (truckerLoadsCache.length === 0) { renderEmptyState($('#trucker-bidding-container').addClass('hidden'), 'No loads assigned for bidding.', 'fa-truck-loading'); $('#trucker-bidding-table-container').removeClass('hidden').html(renderEmptyState(null, 'No loads assigned for bidding.', 'fa-truck-loading')); return; } toggleTruckerLoadsView(currentTruckerViewMode); } catch (e) {} }
        function toggleTruckerLoadsView(mode) { currentTruckerViewMode = mode; $('#view-mode-cards, #view-mode-table').removeClass('active'); $(`#view-mode-${mode}`).addClass('active'); if (mode === 'cards') { $('#trucker-bidding-container').removeClass('hidden'); $('#trucker-bidding-table-container').addClass('hidden'); renderBiddingCards(truckerLoadsCache); } else { $('#trucker-bidding-container').addClass('hidden'); $('#trucker-bidding-table-container').removeClass('hidden'); renderBiddingTable(truckerLoadsCache); } }
        function renderBiddingCards(loads) { const container = $('#trucker-bidding-container'); container.html(loads.map(load => { const history = (load.my_bid_history || []).map((b, i) => `<li>Bid ${i + 1}: <strong>${formatCurrency(b.bid_amount)}</strong> (Rank: L${b.rank || 'N/A'})</li>`).join(''); return `<div class="card bidding-card" data-load-id="${load.load_id}"><div class="card-header bg-light d-flex justify-content-between flex-wrap gap-2"><h6 class="mb-0">Load ID: ${load.load_id}</h6><div><button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="popover" data-bs-html="true" title="My Bidding History" data-bs-content="${history || 'No past bids.'}"><i class="fas fa-history"></i></button><span class="badge bg-${load.my_rank ? 'primary' : 'secondary'} ms-2">My Rank: ${load.my_rank ? `L${load.my_rank}` : 'N/A'}</span></div></div><div class="card-body"><div><small class="text-muted d-block">Route</small><strong>${load.loading_point_address} <i class="fas fa-arrow-right"></i> ${load.unloading_point_address}</strong></div><div><small class="text-muted d-block">Material</small><strong>${load.item_name}</strong></div><div><small class="text-muted d-block">Weight</small><strong>${load.approx_weight_tonnes} T</strong></div><div><small class="text-muted d-block">Vehicle</small><strong>${load.truck_name}</strong></div><div><small class="text-muted d-block">Date</small><strong>${formatDate(load.requirement_date)}</strong></div></div><div class="bid-input-area p-3">${(load.bid_attempts || 0) >= 3 ? `<div class="text-center text-danger small p-3"><i class="fas fa-exclamation-circle me-1"></i> Max 3 bids reached.</div>` : `<div class="input-group"><span class="input-group-text"></span><input type="number" step="100" class="form-control bid-amount-input" placeholder="Your Total Bid (Attempt ${(load.bid_attempts || 0) + 1})"></div>`}</div></div>` }).join('')); $('[data-bs-toggle="popover"]').popover({ trigger: 'hover focus' }); }
        function renderBiddingTable(loads) { const container = $('#trucker-bidding-table-container'); const tableHTML = `<div class="table-responsive p-0"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Load ID</th><th>Loading Point</th><th>Unloading Point</th><th>Details</th><th>History</th><th>My Rank</th><th>My Bid</th></tr></thead><tbody>${loads.map(load => { const history = (load.my_bid_history || []).map((b, i) => `<li>Bid ${i + 1}: <strong>${formatCurrency(b.bid_amount)}</strong> (Rank: L${b.rank || 'N/A'})</li>`).join(''); return `<tr data-load-id="${load.load_id}"><td>${load.load_id}</td><td><small>${load.loading_point_address}</small></td><td><small>${load.unloading_point_address}</small></td><td><small>${load.item_name}, ${load.approx_weight_tonnes}T, ${load.truck_name}</small></td><td><button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="popover" data-bs-html="true" title="My Bidding History" data-bs-content="${history || 'No past bids.'}"><i class="fas fa-history"></i></button></td><td><span class="badge bg-${load.my_rank ? 'primary' : 'secondary'}">${load.my_rank ? `L${load.my_rank}` : 'N/A'}</span></td><td>${(load.bid_attempts || 0) >= 3 ? `<span class="text-danger small">Max bids</span>` : `<div class="input-group input-group-sm"><span class="input-group-text"></span><input type="number" class="form-control bid-amount-input" placeholder="Amount"></div>`}</td></tr>` }).join('')}</tbody></table></div>`; container.html(tableHTML); $('[data-bs-toggle="popover"]').popover({ trigger: 'hover focus' }); }
        async function handleBulkBidSubmit() { const bids = $('.bid-amount-input').map(function() { if ($(this).val()) { const loadId = $(this).closest('[data-load-id]').data('load-id'); return { loadId: loadId, bid_amount: parseFloat($(this).val()) }; } }).get(); if (bids.length === 0) return showToast('No new bids entered.', 'info'); try { await apiCall('/bids', 'POST', { bids }); showToast('Bids submitted!', 'success'); load_trucker_open_loads_view(); } catch (e) {} }
        async function load_trucker_bidding_history_view() { const tbody = $('#trucker-bids-tbody'), empty = $('#trucker-bids-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/trucker/bidding-history'); if (result.data.length === 0) return renderEmptyState(empty, 'No bidding history found.', 'fa-gavel'); tbody.html(result.data.map(b => `<tr><td>${b.load_id}</td><td><small>${b.loading_point_address} <i class="fas fa-arrow-right"></i> ${b.unloading_point_address}</small></td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td><span class="badge bg-info">L${b.rank || 'N/A'}</span></td><td>${b.l1_bid ? formatCurrency(b.l1_bid) : '-'}</td><td><span class="badge bg-${getBadgeColor(b.status)}">${b.status}</span></td><td>${formatDate(b.submitted_at, true)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch (e) {} }
        async function load_trucker_awarded_contracts_view() { const tbody = $('#trucker-awarded-tbody'), empty = $('#trucker-awarded-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/trucker/awarded-contracts'); if (result.data.length === 0) return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy'); tbody.html(result.data.map(c => `<tr><td>${c.load_id}</td><td><small>${c.loading_point_address} <i class="fas fa-arrow-right"></i> ${c.unloading_point_address}</small></td><td><strong>${formatCurrency(c.awarded_amount)}</strong></td><td>${formatDate(c.awarded_date)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch (e) {} }
        async function load_admin_dashboard_view() { try { const result = await apiCall('/admin/dashboard-stats'); const data = result.data; $('#stats-active-loads').text(data.activeLoads || '0'); $('#stats-pending-users').text(data.pendingUsers || '0'); $('#stats-pending-loads').text(data.pendingLoads || '0'); $('#stats-awarded-contracts').text(data.awardedContracts || '0'); createChart('adminLoadChart', 'bar', { labels: data.charts.loadTrends.labels, datasets: [{ label: 'Loads Created', data: data.charts.loadTrends.data, backgroundColor: '#5E72E4' }] }); createChart('adminTruckerBiddingChart', 'doughnut', { labels: data.charts.biddingActivity.labels, datasets: [{ data: data.charts.biddingActivity.data, backgroundColor: ['#5E72E4', '#2DCE89', '#FB6340', '#11CDEF', '#F5365C'] }] }); } catch (e) {} }
        async function load_admin_pending_loads_view() { const container = $('#pending-loads-accordion-container'); try { renderEmptyState(container, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/loads/pending'); if (!result.data || result.data.groupedReqs.length === 0) return renderEmptyState(container, 'No loads are pending approval.', 'fa-inbox'); const { groupedReqs, pendingLoads, allTruckers } = result.data; const accordion = $('<div class="accordion"></div>'); groupedReqs.forEach(req => { const reqLoads = pendingLoads.filter(load => load.requisition_id == req.requisition_id); if (reqLoads.length === 0) return; const loadsHTML = reqLoads.map(load => `<li class="list-group-item"><input class="form-check-input me-2 load-check-box" type="checkbox" value="${load.load_id}" checked><label class="form-check-label"><strong>${load.item_name}</strong> from ${load.loading_point_address} to ${load.unloading_point_address}<small class="text-muted d-block">Vehicle: ${load.truck_name} | Weight: ${load.approx_weight_tonnes}T | Date: ${formatDate(load.requirement_date)}</small></label></li>`).join(''); const truckersHTML = allTruckers.map(v => `<div class="form-check form-check-inline col-md-3"><input class="form-check-input trucker-assign-check" type="checkbox" value="${v.user_id}" id="v-${req.requisition_id}-${v.user_id}"><label class="form-check-label" for="v-${req.requisition_id}-${v.user_id}">${v.full_name}</label></div>`).join(''); accordion.append(`<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${req.requisition_id}">TRN: REQ-${req.requisition_id} (By: ${req.creator}) - ${reqLoads.length} Load(s)</button></h2><div id="collapse-${req.requisition_id}" class="accordion-collapse collapse"><div class="accordion-body"><h6>Select loads to approve:</h6><ul class="list-group mb-3">${loadsHTML}</ul><h6 class="d-flex justify-content-between"><span>Assign Truckers:</span><div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" onchange="$(this).closest('.accordion-body').find('.trucker-assign-check').prop('checked', this.checked);"><label>Select All</label></div></h6><div class="border rounded p-3 row">${truckersHTML}</div><div class="mt-3"><button class="btn btn-success" onclick="handleBulkApproval('${req.requisition_id}')">Process Selected Loads</button></div></div></div></div>`); }); container.html(accordion); } catch (e) {} }
        async function handleBulkApproval(reqId) { const c = $(`#collapse-${reqId}`), loads = c.find('.load-check-box:checked').map((i, el) => $(el).val()).get(), truckers = c.find('.trucker-assign-check:checked').map((i, el) => $(el).val()).get(); if (loads.length === 0) return showToast('Select at least one load.', 'error'); if (truckers.length === 0) return showToast('Assign at least one trucker.', 'error'); try { await apiCall('/loads/approve', 'POST', { approvedLoadIds: loads, truckerAssignments: truckers, requisitionId: reqId }); showToast('Loads processed!', 'success'); load_admin_pending_loads_view(); } catch (e) {} }
        async function load_admin_all_loads_view() { const tbody = $('#admin-loads-tbody'), empty = $('#admin-loads-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/admin/all-loads'); if (result.data.length === 0) return renderEmptyState(empty, 'No loads found.'); tbody.html(result.data.map(l => `<tr data-load-id="${l.load_id}"><td><input type="checkbox" class="form-check-input load-checkbox"></td><td>REQ-${l.requisition_id}</td><td>${l.load_id}</td><td><small>${l.loading_point_address} <i class="fas fa-arrow-right"></i> ${l.unloading_point_address}</small></td><td><small>${l.assigned_truckers || 'Not Assigned'}</small></td><td><span class="badge bg-${getBadgeColor(l.status)}">${l.status}</span></td><td>${l.l1_trucker || '-'}</td><td>${l.l1_bid ? formatCurrency(l.l1_bid) : '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-info" onclick="openViewBidsModal(${l.load_id})">Bids</button><button class="btn btn-secondary" onclick="openAssignTruckersModal(${l.requisition_id})">Assign</button></div></td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch (e) {} }
        async function load_admin_bidding_history_view() { const tbody = $('#admin-bids-tbody'), empty = $('#admin-bids-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/admin/bidding-history'); if (result.data.length === 0) return renderEmptyState(empty, 'No bidding history found.'); tbody.html(result.data.map(b => `<tr><td>${b.load_id}</td><td><small>${b.loading_point_address} <i class="fas fa-arrow-right"></i> ${b.unloading_point_address}</small></td><td>${b.trucker_name}</td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td>${formatDate(b.submitted_at, true)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch (e) {} }
        async function load_admin_awarded_contracts_view() { const tbody = $('#admin-awarded-tbody'), empty = $('#admin-awarded-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); tbody.parent().hide(); const result = await apiCall('/admin/awarded-contracts'); if (result.data.length === 0) return renderEmptyState(empty, 'No contracts awarded yet.', 'fa-trophy'); tbody.html(result.data.map(c => `<tr><td><input type="checkbox" class="form-check-input awarded-load-checkbox" data-load-id="${c.load_id}"></td><td>${c.load_id}</td><td>REQ-${c.requisition_id}</td><td><small>${c.loading_point_address} <i class="fas fa-arrow-right"></i> ${c.unloading_point_address}</small></td><td>${c.trucker_name}</td><td><small>${c.trucker_email}<br>${c.trucker_contact}</small></td><td><strong>${formatCurrency(c.awarded_amount)}</strong></td><td>${formatDate(c.awarded_date)}</td></tr>`).join('')); tbody.parent().show(); empty.empty(); } catch (e) {} }
        async function openViewBidsModal(loadId) { $('#viewBidsModalTitle').text(`Bids for Load #${loadId}`); $('#viewBidsModalBody').html(renderEmptyState(null, 'Loading bids...', 'fa-spinner fa-spin')); viewBidsModal.show(); try { const result = await apiCall(`/admin/loads/${loadId}/bids`); if (!result.data || !result.data.bids) { throw new Error("Invalid data received for bids."); } if (result.data.bids.length === 0) { $('#viewBidsModalBody').html('<p class="text-center">No bids have been submitted for this load yet.</p>'); return; } const bidsHTML = `<table class="table table-sm"><thead><tr><th>Select</th><th>Rank</th><th>Trucker</th><th>Bid Amount</th><th>Date</th></tr></thead><tbody>` + result.data.bids.map((b, i) => { const bidData = { ...b, ...result.data.loadDetails }; return `<tr><td><input class="form-check-input" type="radio" name="award-radio-${loadId}" value='${JSON.stringify(bidData)}'></td><td><span class="badge bg-info">L${i + 1}</span></td><td>${b.trucker_name}</td><td><strong>${formatCurrency(b.bid_amount)}</strong></td><td>${formatDate(b.submitted_at, true)}</td></tr>` }).join('') + `</tbody></table><div class="mt-3"><label>Remarks</label><textarea class="form-control" id="award-remarks-${loadId}"></textarea><button class="btn btn-success mt-2 float-end" onclick="handleSingleAward(${loadId})">Award Selected</button></div>`; $('#viewBidsModalBody').html(bidsHTML); } catch (e) { $('#viewBidsModalBody').html(renderEmptyState(null, 'Could not load bids. Please try again.', 'fa-exclamation-triangle')); } }
        async function handleSingleAward(loadId) { const remarks = $(`#award-remarks-${loadId}`).val(); if (!remarks) return showToast('Remarks are mandatory.', 'warning'); const selectedBid = $(`input[name="award-radio-${loadId}"]:checked`).val(); if (!selectedBid) return showToast('Please select a bid to award.', 'warning'); const bidData = JSON.parse(selectedBid); bidData.remarks = remarks; try { await apiCall('/contracts/award', 'POST', { bids: [bidData] }); showToast('Load awarded!', 'success'); viewBidsModal.hide(); handleManualRefresh(); } catch (e) {} }
        async function openAssignTruckersModal(requisitionId) { $('#assign-trucker-req-id').val(requisitionId); const checklistDiv = $('#assign-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin')); assignTruckersModal.show(); try { const result = await apiCall(`/requisitions/${requisitionId}/assignments`); const { allTruckers, assignedTruckerIds } = result.data; const truckersHtml = allTruckers.map(t => `<div class="form-check"><input class="form-check-input assign-trucker-checkbox" type="checkbox" value="${t.user_id}" ${assignedTruckerIds.includes(t.user_id) ? 'checked' : ''}><label class="form-check-label">${t.full_name}</label></div>`).join(''); checklistDiv.html(truckersHtml || '<p class="text-muted">No active truckers found.</p>'); } catch (e) {} }
        async function handleUpdateTruckerAssignments() { const requisitionId = $('#assign-trucker-req-id').val(); const truckerIds = $('#assign-trucker-checklist input:checked').map((i, el) => $(el).val()).get(); try { await apiCall(`/requisitions/${requisitionId}/assignments`, 'PUT', { truckerIds }); showToast('Assignments updated!', 'success'); assignTruckersModal.hide(); if ($('#admin-loads-tbody').length) load_admin_all_loads_view(); } catch (e) {} }
        async function load_admin_user_approvals_view() { const tbody = $('#admin-pending-users-tbody'), empty = $('#admin-pending-users-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/users/pending'); if (result.data.length === 0) return renderEmptyState(empty, 'No users are pending approval.', 'fa-user-check'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.company_name || '-'}</td><td>${u.contact_number || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-success" onclick="approveUser(${u.temp_id})">Approve</button> <button class="btn btn-danger" onclick="rejectUser(${u.temp_id})">Reject</button></div></td></tr>`).join('')); } catch (e) {} }
        async function approveUser(id) { if (confirm('Approve user?')) { try { await apiCall('/users/approve', 'POST', { temp_id: id }); showToast('User Approved!', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        async function rejectUser(id) { if (confirm('Reject user?')) { try { await apiCall(`/pending-users/${id}`, 'DELETE'); showToast('User Rejected.', 'success'); load_admin_user_approvals_view(); } catch (e) {} } }
        async function load_admin_user_control_view() { const tbody = $('#admin-users-tbody'), empty = $('#admin-users-empty-state'); try { renderEmptyState(empty, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/users'); if (result.data.length === 0) return renderEmptyState(empty, 'No users found.', 'fa-users'); empty.empty(); tbody.html(result.data.map(u => `<tr><td>${u.full_name}</td><td>${u.email}</td><td><span class="badge bg-${getBadgeColor(u.role)}">${u.role}</span></td><td>${u.company_name || '-'}</td><td>${u.contact_number || '-'}</td><td>${u.gstin || '-'}</td><td><div class="btn-group btn-group-sm"><button class="btn btn-primary" onclick='openEditUserModal(${JSON.stringify(u)})'>Edit</button><button class="btn btn-danger" onclick="handleDeleteUser(${u.user_id})">Delete</button></div></td></tr>`).join('')); } catch (e) {} }
        function openAddUserModal() { $('#add-user-form')[0].reset(); addUserModal.show(); }
        async function handleAddUserSubmit(e) { e.preventDefault(); const data = { full_name: $('#add-fullname').val(), email: $('#add-email').val(), password: $('#add-password').val(), role: $('#add-role').val(), company_name: $('#add-company').val(), contact_number: $('#add-contact').val(), gstin: $('#add-gstin').val() }; try { await apiCall('/users', 'POST', data); showToast('User created!', 'success'); addUserModal.hide(); $('#add-user-form')[0].reset(); load_admin_user_control_view(); } catch (e) {} }
        function openEditUserModal(u) { $('#edit-userid').val(u.user_id); $('#edit-fullname').val(u.full_name); $('#edit-email').val(u.email); $('#edit-role').val(u.role); $('#edit-company').val(u.company_name || ''); $('#edit-contact').val(u.contact_number || ''); $('#edit-gstin').val(u.gstin || ''); $('#edit-password').val(''); editUserModal.show(); }
        async function handleUserUpdateSubmit(e) { e.preventDefault(); const id = $('#edit-userid').val(), data = { full_name: $('#edit-fullname').val(), email: $('#edit-email').val(), role: $('#edit-role').val(), company_name: $('#edit-company').val(), contact_number: $('#edit-contact').val(), gstin: $('#edit-gstin').val(), password: $('#edit-password').val() }; try { await apiCall(`/users/${id}`, 'PUT', data); showToast('User updated!', 'success'); editUserModal.hide(); load_admin_user_control_view(); } catch (e) {} }
        async function handleDeleteUser(id) { if (confirm('Delete user?')) { try { await apiCall(`/users/${id}`, 'DELETE'); showToast('User deleted.', 'success'); load_admin_user_control_view(); } catch (e) {} } }
        async function load_admin_master_data_view() { try { const [items, trucks] = await Promise.all([apiCall('/master-data/items'), apiCall('/master-data/truck-types')]); $('#item-master-tbody').html(items.data.map(i => `<tr><td>${i.item_name}</td><td><span class="badge bg-${i.is_active ? 'success' : 'danger'}">${i.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("item", ${JSON.stringify(i)})'><i class="fas fa-edit"></i></button></td></tr>`).join('')); $('#truck-master-tbody').html(trucks.data.map(t => `<tr><td>${t.truck_name}</td><td><span class="badge bg-${t.is_active ? 'success' : 'danger'}">${t.is_active ? 'Active' : 'Inactive'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick='openMasterDataModal("truck", ${JSON.stringify(t)})'><i class="fas fa-edit"></i></button></td></tr>`).join('')); } catch (e) {} }
        function openMasterDataModal(type, data = null) { const isEdit = data !== null; $('#master-data-modal-title').text(`${isEdit ? 'Edit' : 'Add'} ${type === 'item' ? 'Material' : 'Truck Type'}`); const form = $('#master-data-form'); form.data('type', type); form.data('id', isEdit ? (data.item_id || data.truck_type_id) : ''); $('#master-name').val(isEdit ? (data.item_name || data.truck_name) : ''); if (isEdit) { $('#master-active-switch').show(); $('#master-active').prop('checked', data.is_active); } else { $('#master-active-switch').hide(); } masterDataModal.show(); }
        async function handleMasterDataSubmit(e) { e.preventDefault(); const form = $(e.currentTarget); const type = form.data('type'), id = form.data('id'), isEdit = id !== ''; const name = $('#master-name').val(), isActive = $('#master-active').is(':checked'); const endpoint = isEdit ? `/master-data/${type}s/${id}` : `/master-data/${type}s`; const method = isEdit ? 'PUT' : 'POST'; const body = isEdit ? { name: name, is_active: isActive } : { name: name }; try { await apiCall(endpoint, method, body); showToast(`${type} data saved!`, 'success'); masterDataModal.hide(); load_admin_master_data_view(); } catch (e) {} }
        function openBulkUploadModal(type) { $('#bulk-upload-modal-title').text(`Bulk Upload ${type === 'item' ? 'Materials' : (type === 'truck' ? 'Truck Types' : 'Loads')}`); $('#download-template-link').off('click').on('click', () => downloadBulkTemplate(type)); $('#bulk-upload-type').val(type); bulkUploadModal.show(); }
        async function handleBulkUpload(e) { e.preventDefault(); const file = $('#bulk-upload-file')[0].files[0]; if (!file) return showToast('Please select a file.', 'error'); const type = $('#bulk-upload-type').val(); const endpoint = type === 'load' ? '/loads/bulk-upload' : `/master-data/${type}s/bulk-upload`; const formData = new FormData(); formData.append('bulkFile', file); try { await apiCall(endpoint, 'POST', formData, true); showToast('File uploaded and processed.', 'success'); bulkUploadModal.hide(); if (type !== 'load') load_admin_master_data_view(); else navigateTo('admin-pending-loads-view'); } catch (e) {} }
        function downloadBulkTemplate(type) { let data, filename; if (type === 'load') { data = [{ "LoadingPoint": "City A", "UnloadingPoint": "City B", "MaterialName": "STEEL ITEMS", "TruckName": "10 Wheeler Truck", "WeightInTonnes": 15, "RequirementDate": "2025-10-25" }]; filename = "Bulk_Load_Template.xlsx"; } else { data = [{ "Name": `Sample ${type === 'item' ? 'Material' : 'Truck'}` }]; filename = `Bulk_${type}_Template.xlsx`; } const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Template"); XLSX.writeFile(wb, filename); }
        async function load_admin_reports_view() { const kpiContainer = $('#report-kpis'), tableBody = $('#detailed-report-table tbody'); try { kpiContainer.html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin')); tableBody.empty(); const result = await apiCall('/admin/reports-data', 'POST', { startDate: $('#report-start-date').val(), endDate: $('#report-end-date').val() }); const { kpis, detailedReport } = result.data; kpiContainer.html(`<div class="col-md-6"><div class="card card-body"><h6>Total Spend</h6><h3 class="fw-bold">${formatCurrency(kpis.totalSpend)}</h3></div></div><div class="col-md-6"><div class="card card-body"><h6>Total Loads Awarded</h6><h3 class="fw-bold">${kpis.awardedLoads}</h3></div></div>`); if (detailedReport.length === 0) { tableBody.html(`<tr><td colspan="6" class="text-center text-muted">No data for this period.</td></tr>`); } else { tableBody.html(detailedReport.map(r => `<tr><td>${r.load_id}</td><td><small>${r.loading_point_address} <i class="fas fa-arrow-right"></i> ${r.unloading_point_address}</small></td><td>${r.item_name}</td><td>${r.trucker_name}</td><td>${formatCurrency(r.awarded_amount)}</td><td>${formatDate(r.awarded_date)}</td></tr>`).join('')); } } catch (e) {} }
        function downloadReport() { const table = document.getElementById("detailed-report-table"); if (!table || $(table).find('tbody tr').length === 0 || $(table).find('tbody td').length <= 1) return showToast('No data to download.', 'warning'); const wb = XLSX.utils.table_to_book(table, { sheet: "Report" }); XLSX.writeFile(wb, "Awarded_Loads_Report.xlsx"); }
        function downloadTableData(tableId, filename) { const table = document.getElementById(tableId); if (!table || $(table).find('tbody tr').length === 0 || $(table).find('tbody td').length <= 1) return showToast('No data to download.', 'warning'); const wb = XLSX.utils.table_to_book(table, { sheet: "Report" }); XLSX.writeFile(wb, filename); }
        async function load_messaging_view() { const chatList = $('#chat-list'); try { renderEmptyState(chatList, 'Loading...', 'fa-spinner fa-spin'); const result = await apiCall('/conversations'); if (result.data.length === 0) return renderEmptyState(chatList, 'No users to chat with.'); chatList.html(result.data.map(u => `<a href="#" class="list-group-item list-group-item-action" onclick="openChat(${u.user_id}, '${u.full_name}')">${u.full_name} <small class="text-muted">(${u.role})</small></a>`).join('')); } catch (e) {} }
        async function openChat(id, name) { if (chatPollingInterval) clearInterval(chatPollingInterval); $('#chat-welcome').addClass('d-none'); $('#chat-window').removeClass('d-none'); $('#chat-with-name').text(name); $('#message-form').off('submit').on('submit', (e) => { e.preventDefault(); handleSendMessage(id); }); const fetchAndRender = async () => { const messagesDiv = $('#chat-messages'); const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser')); const result = await apiCall(`/messages/${id}`, 'GET', null, false, false); if (!result.success) return; const isScrolledToBottom = messagesDiv.scrollTop() + messagesDiv.innerHeight() >= messagesDiv[0].scrollHeight - 20; messagesDiv.html(''); result.data.forEach(msg => { messagesDiv.append(`<div class="message-bubble ${msg.sender_id == currentUser.user_id ? 'sent' : 'received'}"><div>${msg.message_body.replace(/\n/g, '<br>')}</div><div class="timestamp">${formatDate(msg.timestamp, true)}</div></div>`); }); if (isScrolledToBottom || messagesDiv.html() === '') { messagesDiv.scrollTop(messagesDiv[0].scrollHeight); } }; await fetchAndRender(); chatPollingInterval = setInterval(fetchAndRender, 7000); }
        async function handleSendMessage(id) { const input = $('#message-input'); if (!input.val()) return; try { await apiCall('/messages', 'POST', { recipientId: id, messageBody: input.val() }, false, false); input.val(''); openChat(id, $('#chat-with-name').text()); } catch (e) {} }
        async function fetchSidebarCounts() { try { const result = await apiCall('/sidebar-counts', 'GET', null, false, false); if (result.success) { $('#badge-unread-messages').text(result.data.unreadMessages > 0 ? result.data.unreadMessages : '').toggle(result.data.unreadMessages > 0); $('#badge-pending-loads').text(result.data.pendingLoads > 0 ? result.data.pendingLoads : '').toggle(result.data.pendingLoads > 0); $('#badge-pending-users').text(result.data.pendingUsers > 0 ? result.data.pendingUsers : '').toggle(result.data.pendingUsers > 0); } } catch (e) {} }
        function showToast(m, t = 'info') { const c = $('#toast-container'), e = $(`<div><i class="fas ${t === 'success' ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i><span>${m}</span></div>`).addClass(`toast-notification ${t}`); c.append(e); setTimeout(() => e.remove(), 4000); }
        function showLoader() { $('#loader-overlay').removeClass('hidden'); }
        function hideLoader() { $('#loader-overlay').addClass('hidden'); }
        function renderEmptyState(container, message, iconClass = 'fa-folder-open') { const html = `<div class="empty-state w-100"><i class="fas ${iconClass}"></i><p>${message}</p></div>`; if (container) $(container).html(html); return html; }
        function formatCurrency(v) { const n = parseFloat(v); return isNaN(n) ? '0' : `${n.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`; }
        function formatDate(d, includeTime = false) { if (!d) return 'N/A'; const date = new Date(d); const options = { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Kolkata' }; if (includeTime) { options.hour = 'numeric'; options.minute = '2-digit'; options.hour12 = true; } return new Intl.DateTimeFormat('en-IN', options).format(date); }
        function getBadgeColor(s) { return { 'Awarded': 'primary', 'Active': 'success', 'Pending Approval': 'warning', 'Submitted': 'info', 'Rejected': 'danger', 'Processed': 'secondary', 'Admin': 'info', 'Super Admin': 'danger', 'Trucker': 'success', 'Shipper': 'secondary' }[s] || 'dark'; }
        function createChart(chartId, type, data, options = {}) { if (charts[chartId]) charts[chartId].destroy(); const ctx = document.getElementById(chartId)?.getContext('2d'); if (!ctx) return; charts[chartId] = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } }); }
        
        async function openAdvancedBulkAwardModal() {
            const loadIds = $('.load-checkbox:checked').map((i, el) => $(el).closest('tr').data('load-id')).get();
            if (loadIds.length === 0) return showToast('Please select loads to award.', 'warning');
            try {
                const result = await apiCall('/admin/bids-for-loads', 'POST', { loadIds });
                if (!result.success) return;
                const accordionContainer = $('#advanced-bulk-award-modal-body').html('');
                result.data.forEach((loadData, index) => {
                    let bidsTableHtml = '<p class="text-center text-muted">No bids submitted.</p>';
                    if (loadData.bids && loadData.bids.length > 0) {
                        bidsTableHtml = `<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr><th>Select</th><th>Rank</th><th>Trucker</th><th>Amount ()</th></tr></thead><tbody>${loadData.bids.map((bid, rankIndex) => { const bidDataForAward = { ...bid, ...loadData }; return `<tr><td><input class="form-check-input" type="radio" name="award-radio-${loadData.load_id}" value='${JSON.stringify(bidDataForAward)}'></td><td><span class="badge bg-info">L${rankIndex + 1}</span></td><td>${bid.trucker_name}</td><td><strong>${formatCurrency(bid.bid_amount)}</strong></td></tr>`; }).join('')}</tbody></table></div>`;
                    }
                    accordionContainer.append(`<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${index > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-award-${loadData.load_id}"><strong>Load #${loadData.load_id}:</strong> ${loadData.loading_point_address} to ${loadData.unloading_point_address}</button></h2><div id="collapse-award-${loadData.load_id}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#advanced-bulk-award-modal-body"><div class="accordion-body">${bidsTableHtml}</div></div></div>`);
                });
                $('#advanced-bulk-award-remarks').val('');
                advancedBulkAwardModal.show();
            } catch (e) {
                advancedBulkAwardModal.hide();
                showToast('Failed to load data for bulk award. Please try again.', 'error');
            }
        }

        async function handleSubmitAdvancedBulkAward() {
            const remarks = $('#advanced-bulk-award-remarks').val().trim();
            if (!remarks) return showToast('Remarks are mandatory.', 'error');
            const winningBids = $('#advanced-bulk-award-modal-body input[type="radio"]:checked').map((i, radio) => {
                const bidData = JSON.parse(radio.value);
                bidData.remarks = remarks;
                return bidData;
            }).get();
            if (winningBids.length === 0) return showToast('Please select at least one bid to award.', 'warning');
            try {
                await apiCall('/contracts/award', 'POST', { bids: winningBids });
                showToast('Loads awarded successfully!', 'success');
                advancedBulkAwardModal.hide();
                handleManualRefresh();
            } catch (e) {}
        }

        function openReopenBiddingModal() {
            const loadIdsToReopen = $('.awarded-load-checkbox:checked').map((i, el) => $(el).data('load-id')).get();
            if (loadIdsToReopen.length === 0) return showToast('Please select at least one awarded load to re-open.', 'info');
            $('#reopen-load-ids').val(JSON.stringify(loadIdsToReopen));
            $('#reopen-remarks').val('');
            const checklistDiv = $('#reopen-trucker-checklist').html(renderEmptyState(null, 'Loading...', 'fa-spinner fa-spin'));
            reopenBiddingModal.show();
            apiCall('/users/truckers', 'GET', null, false, false).then(result => {
                if (result.success && result.data) {
                    const truckersHtml = result.data.map(t => `<div class="form-check"><input class="form-check-input reopen-trucker-checkbox" type="checkbox" value="${t.user_id}" id="reopen-t-${t.user_id}" checked><label class="form-check-label" for="reopen-t-${t.user_id}">${t.full_name}</label></div>`).join('');
                    checklistDiv.html(truckersHtml || '<p class="text-muted">No truckers found.</p>');
                } else {
                    checklistDiv.html('<p class="text-danger">Could not load trucker list.</p>');
                }
            });
        }
        async function submitReopenBidding() {
            const loadIds = JSON.parse($('#reopen-load-ids').val());
            const remarks = $('#reopen-remarks').val().trim();
            const truckerIds = $('#reopen-trucker-checklist .reopen-trucker-checkbox:checked').map((i, el) => $(el).val()).get();
            if (!remarks) return showToast('Remarks are mandatory.', 'error');
            if (truckerIds.length === 0) return showToast('Please select at least one trucker.', 'error');
            try {
                await apiCall('/loads/reopen-bidding', 'POST', { loadIds, remarks, truckerIds });
                showToast('Bidding re-opened successfully!', 'success');
                reopenBiddingModal.hide();
                handleManualRefresh();
            } catch (e) {}
        }
    </script>
</body>
</html>
